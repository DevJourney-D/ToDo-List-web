<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tasks - ToDo List App</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÖ</text></svg>">
    <link href="./dist/styles.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .task-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: #3b82f6;
        }
        
        .task-card.completed {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-color: #10b981;
            opacity: 0.7;
        }
        
        .task-card.overdue {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-color: #f87171;
        }
        
        .priority-high {
            border-left: 4px solid #ef4444;
        }
        
        .priority-medium {
            border-left: 4px solid #f59e0b;
        }
        
        .priority-low {
            border-left: 4px solid #10b981;
        }
        
        .add-task-form {
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        
        .add-task-form:hover {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #eff6ff 0%, #f8fafc 100%);
        }
        
        .modal-overlay {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }
        
        .modal-content {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            color: #475569;
            border: 1px solid #cbd5e1;
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            color: #334155;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }
        
        .filter-tab {
            transition: all 0.3s ease;
            border-radius: 20px;
            padding: 8px 16px;
        }
        
        .filter-tab.active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            transform: scale(1.05);
        }
        
        .search-input {
            background: white;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .task-checkbox {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #cbd5e1;
            border-radius: 4px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .task-checkbox:checked {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-color: #10b981;
        }
        
        .task-checkbox:checked::after {
            content: '‚úì';
            color: white;
            font-size: 14px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .empty-state {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 2px dashed #cbd5e1;
        }
        
        .category-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .status-pending { color: #f59e0b; }
        .status-in-progress { color: #3b82f6; }
        .status-completed { color: #10b981; }
        .status-cancelled { color: #ef4444; }
        
        @media (max-width: 768px) {
            .task-card {
                margin-bottom: 1rem;
            }
            
            .modal-content {
                margin: 1rem;
                max-height: calc(100vh - 2rem);
                overflow-y: auto;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation will be injected here -->
    
    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <!-- Welcome Section -->
        <div id="welcomeSection" class="mb-8">
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 id="welcomeMessage" class="text-3xl font-bold mb-2">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ! üëã</h1>
                        <p id="welcomeSubtext" class="text-blue-100">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...</p>
                    </div>
                    <div class="text-right">
                        <div id="currentDateTime" class="text-blue-100 text-sm"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Stats -->
        <div id="dashboardStats" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8" style="display: none;">
            <!-- ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ -->
            <div class="bg-gradient-to-br from-orange-400 to-orange-600 rounded-lg p-4 text-white shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-orange-100 text-sm font-medium">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥</p>
                        <p id="pendingCount" class="text-2xl font-bold">0</p>
                    </div>
                    <div class="text-3xl opacity-80">‚è≥</div>
                </div>
                <div class="mt-2">
                    <div class="flex items-center text-orange-100 text-xs">
                        <i class="fas fa-clock mr-1"></i>
                        <span>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
                    </div>
                </div>
            </div>

            <!-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥ -->
            <div class="bg-gradient-to-br from-blue-400 to-blue-600 rounded-lg p-4 text-white shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-100 text-sm font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</p>
                        <p id="inProgressCount" class="text-2xl font-bold">0</p>
                    </div>
                    <div class="text-3xl opacity-80">üîÑ</div>
                </div>
                <div class="mt-2">
                    <div class="flex items-center text-blue-100 text-xs">
                        <i class="fas fa-play mr-1"></i>
                        <span>‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡∏π‡πà</span>
                    </div>
                </div>
            </div>

            <!-- ‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß -->
            <div class="bg-gradient-to-br from-green-400 to-green-600 rounded-lg p-4 text-white shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-green-100 text-sm font-medium">‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</p>
                        <p id="completedCount" class="text-2xl font-bold">0</p>
                    </div>
                    <div class="text-3xl opacity-80">‚úÖ</div>
                </div>
                <div class="mt-2">
                    <div class="flex items-center text-green-100 text-xs">
                        <i class="fas fa-check mr-1"></i>
                        <span>‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</span>
                    </div>
                </div>
            </div>

            <!-- ‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î -->
            <div class="bg-gradient-to-br from-red-400 to-red-600 rounded-lg p-4 text-white shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-red-100 text-sm font-medium">‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î</p>
                        <p id="overdueCount" class="text-2xl font-bold">0</p>
                    </div>
                    <div class="text-3xl opacity-80">‚ö†Ô∏è</div>
                </div>
                <div class="mt-2">
                    <div class="flex items-center text-red-100 text-xs">
                        <i class="fas fa-exclamation-triangle mr-1"></i>
                        <span>‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡πà‡∏ß‡∏ô</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Overview -->
        <div id="progressOverview" class="bg-white rounded-lg shadow-sm p-6 mb-8" style="display: none;">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">üìä ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°</h3>
            <div class="space-y-4">
                <!-- Overall Progress -->
                <div>
                    <div class="flex justify-between text-sm text-gray-600 mb-1">
                        <span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                        <span id="overallProgress">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div id="overallProgressBar" class="bg-gradient-to-r from-blue-500 to-green-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Today's Tasks -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 pt-4">
                    <div class="text-center p-3 bg-blue-50 rounded-lg">
                        <div class="text-2xl font-bold text-blue-600" id="todayTotal">0</div>
                        <div class="text-sm text-blue-600">‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                    </div>
                    <div class="text-center p-3 bg-green-50 rounded-lg">
                        <div class="text-2xl font-bold text-green-600" id="todayCompleted">0</div>
                        <div class="text-sm text-green-600">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</div>
                    </div>
                    <div class="text-center p-3 bg-orange-50 rounded-lg">
                        <div class="text-2xl font-bold text-orange-600" id="todayRemaining">0</div>
                        <div class="text-sm text-orange-600">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Controls Section -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
            <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between mb-6">
                <!-- Search -->
                <div class="w-full lg:w-1/3">
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô..." 
                               class="search-input w-full pl-10 pr-4 py-2 rounded-lg outline-none">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                </div>
                
                <!-- Add Task Button -->
                <button onclick="openAddTaskModal()" 
                        class="btn-primary text-white px-6 py-2 rounded-lg font-medium flex items-center gap-2">
                    <i class="fas fa-plus"></i>
                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
                </button>
            </div>
            
            <!-- Filters -->
            <div class="flex flex-wrap gap-2 mb-4">
                <button onclick="setFilter('all')" class="filter-tab active" data-filter="all">
                    <i class="fas fa-list"></i> ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (<span id="count-all">0</span>)
                </button>
                <button onclick="setFilter('pending')" class="filter-tab" data-filter="pending">
                    <i class="fas fa-clock"></i> ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (<span id="count-pending">0</span>)
                </button>
                <button onclick="setFilter('in-progress')" class="filter-tab" data-filter="in-progress">
                    <i class="fas fa-play"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥ (<span id="count-in-progress">0</span>)
                </button>
                <button onclick="setFilter('completed')" class="filter-tab" data-filter="completed">
                    <i class="fas fa-check"></i> ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß (<span id="count-completed">0</span>)
                </button>
                <button onclick="setFilter('overdue')" class="filter-tab" data-filter="overdue">
                    <i class="fas fa-exclamation-triangle"></i> ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î (<span id="count-overdue">0</span>)
                </button>
            </div>
            
            <!-- Sort Options -->
            <div class="flex flex-wrap gap-2">
                <select id="sortBy" onchange="applySorting()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                    <option value="created_at">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á</option>
                    <option value="due_date">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</option>
                    <option value="priority">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</option>
                    <option value="title">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠</option>
                </select>
                <select id="sortOrder" onchange="applySorting()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                    <option value="desc">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô</option>
                    <option value="asc">‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô</option>
                </select>
            </div>
        </div>
        
        <!-- Tasks Grid -->
        <div id="tasksContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Loading State -->
            <div id="loadingState" class="col-span-full flex justify-center items-center py-12">
                <div class="text-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
                    <p class="text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                </div>
            </div>
        </div>
        
        <!-- Empty State -->
        <div id="emptyState" class="empty-state rounded-lg p-12 text-center" style="display: none;">
            <div class="text-6xl mb-4">üìù</div>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</h3>
            <p class="text-gray-600 mb-6">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏¢!</p>
            <button onclick="openAddTaskModal()" class="btn-primary text-white px-6 py-3 rounded-lg font-medium">
                <i class="fas fa-plus mr-2"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
            </button>
        </div>
    </div>
    
    <!-- Add/Edit Task Modal -->
    <div id="taskModal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center" style="display: none;">
        <div class="modal-content rounded-lg max-w-md w-full max-h-screen overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="modalTitle" class="text-xl font-semibold text-gray-900">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
                    <button onclick="closeTaskModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="taskForm" onsubmit="saveTask(event)">
                    <input type="hidden" id="taskId" value="">
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô *</label>
                        <input type="text" id="taskTitle" required 
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                               placeholder="‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô...">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                        <textarea id="taskDescription" rows="3"
                                  class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                                  placeholder="‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô..."></textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</label>
                        <select id="taskPriority" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                            <option value="low">‡∏ï‡πà‡∏≥</option>
                            <option value="medium">‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option>
                            <option value="high">‡∏™‡∏π‡∏á</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                        <div class="space-y-2">
                            <select id="taskCategorySelect" onchange="handleCategorySelect()" 
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà...</option>
                                <option value="‡∏á‡∏≤‡∏ô">üè¢ ‡∏á‡∏≤‡∏ô</option>
                                <option value="‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß">üë§ ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</option>
                                <option value="‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">üìö ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                                <option value="‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß</option>
                                <option value="‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û">üí™ ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</option>
                                <option value="‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô">üí∞ ‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</option>
                                <option value="‡∏á‡∏≤‡∏ô‡∏≠‡∏î‡∏¥‡πÄ‡∏£‡∏Å">üé® ‡∏á‡∏≤‡∏ô‡∏≠‡∏î‡∏¥‡πÄ‡∏£‡∏Å</option>
                                <option value="‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á">‚úàÔ∏è ‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</option>
                                <option value="‡∏ä‡πá‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á">üõí ‡∏ä‡πá‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á</option>
                                <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">üìù ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                                <option value="custom">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà...</option>
                            </select>
                            <input type="text" id="taskCategory" placeholder="‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà..." 
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                                   style="display: none;">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</label>
                        <input type="date" id="taskDueDate" 
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        <div class="mt-1 text-xs text-gray-500">
                            <i class="fas fa-info-circle"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="flex items-center space-x-2 mb-2">
                            <input type="checkbox" id="taskRecurring" onchange="toggleRecurringOptions()"
                                   class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="taskRecurring" class="text-sm font-medium text-gray-700">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏ã‡πâ‡∏≥</label>
                        </div>
                        <div id="recurringOptions" style="display: none;" class="mt-2">
                            <select id="taskRecurringFrequency" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà...</option>
                                <option value="daily">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option>
                                <option value="weekly">‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option>
                                <option value="monthly">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                                <option value="yearly">‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex gap-3">
                        <button type="submit" class="btn-primary text-white px-6 py-2 rounded-lg font-medium flex-1">
                            <i class="fas fa-save mr-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                        </button>
                        <button type="button" onclick="closeTaskModal()" class="btn-secondary px-6 py-2 rounded-lg font-medium">
                            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center" style="display: none;">
        <div class="modal-content rounded-lg max-w-sm w-full mx-4">
            <div class="p-6 text-center">
                <div class="w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-trash text-2xl text-red-500"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">‡∏•‡∏ö‡∏á‡∏≤‡∏ô</h3>
                <p class="text-gray-600 mb-6">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ</p>
                <div class="flex gap-3">
                    <button onclick="closeDeleteModal()" class="btn-secondary px-4 py-2 rounded-lg font-medium flex-1">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button onclick="confirmDelete()" class="btn-danger text-white px-4 py-2 rounded-lg font-medium flex-1">
                        ‡∏•‡∏ö
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="nav-component.js"></script>
    <script>
        // Global variables
        let allTasks = [];
        let filteredTasks = [];
        let currentFilter = 'all';
        let currentSort = { by: 'created_at', order: 'desc' };
        let taskToDelete = null;
        let isEditing = false;
        let userInfo = null;
        let isDataLoaded = false;
        
        // API Configuration
        const API_BASE_URL = 'https://to-do-list-api-app.vercel.app/api/v1';
        
        console.log('API Base URL configured:', API_BASE_URL);
        
        // Debug functions - accessible from console
        window.debugLogout = function() {
            console.log('Manual logout triggered');
            localStorage.removeItem('token');
            showToast('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤...', 'info');
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1000);
        };
        
        window.debugTokenInfo = function() {
            const token = localStorage.getItem('token');
            if (token) {
                try {
                    const tokenParts = token.split('.');
                    if (tokenParts.length === 3) {
                        const payload = JSON.parse(atob(tokenParts[1]));
                        console.log('Token Info:', {
                            payload,
                            expires: new Date(payload.exp * 1000),
                            isExpired: payload.exp * 1000 < Date.now()
                        });
                    }
                } catch (e) {
                    console.error('Invalid token:', e);
                }
            } else {
                console.log('No token found');
            }
        };
        
        window.debugRefreshTasks = function() {
            console.log('Manual task refresh triggered');
            loadTasks();
        };
        
        // Test API connection on startup
        async function testAPIConnection() {
            try {
                console.log('Testing basic API connection...');
                const response = await fetch(`${API_BASE_URL.replace('/api/v1', '')}/health`);
                console.log('Basic health check:', response.status, response.ok);
                if (response.ok) {
                    const data = await response.json();
                    console.log('Health check data:', data);
                }
            } catch (error) {
                console.error('Basic API connection failed:', error);
            }
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - Starting initialization...');
            testAPIConnection(); // Test API first
            checkAuthentication();
            setupEventListeners();
            updateDateTime();
            setInterval(updateDateTime, 1000); // Update every second
            console.log('Starting page initialization...');
            initializePage(); // Initialize after DOM is ready
        });
        
        // Initialize page with proper sequence
        async function initializePage() {
            try {
                console.log('Initialize page started...');
                
                // Test API connectivity first
                console.log('Testing API connectivity...');
                try {
                    const healthCheck = await fetch(`${API_BASE_URL}/health`);
                    console.log('Health check response:', healthCheck.status, healthCheck.ok);
                } catch (apiError) {
                    console.error('API Health check failed:', apiError);
                    showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
                }
                
                // Step 1: Load user info first
                console.log('Loading user info...');
                await loadUserInfo();
                
                // Step 2: Load tasks after user info
                console.log('Loading tasks...');
                await loadTasks();
                
                // Step 3: Show dashboard stats
                console.log('Showing dashboard elements...');
                showDashboardElements();
                
                // Step 4: Show success message
                console.log('Showing welcome message...');
                showWelcomeMessage();
                
                console.log('Page initialization completed successfully');
                
            } catch (error) {
                console.error('Failed to initialize page:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message, 'error');
            }
        }
        
        // Load user information first
        async function loadUserInfo() {
            try {
                const token = localStorage.getItem('token');
                if (!token) return;
                
                const data = await apiRequest('/user/info');
                if (data && data.user) {
                    userInfo = data.user;
                    updateWelcomeSection();
                    return userInfo;
                }
            } catch (error) {
                console.warn('Failed to load user info:', error);
                // Continue even if user info fails
                userInfo = { username: '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', email: '' };
                updateWelcomeSection();
            }
        }
        
        // Update welcome section with user info
        function updateWelcomeSection() {
            const welcomeMessage = document.getElementById('welcomeMessage');
            const welcomeSubtext = document.getElementById('welcomeSubtext');
            
            if (userInfo) {
                const timeOfDay = getTimeOfDayGreeting();
                welcomeMessage.textContent = `${timeOfDay} ${userInfo.username}! üëã`;
                welcomeSubtext.textContent = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á? ‡∏°‡∏≤‡∏î‡∏π‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏¢! üöÄ';
            }
        }
        
        // Get appropriate greeting based on time of day
        function getTimeOfDayGreeting() {
            const hour = new Date().getHours();
            if (hour < 12) return '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤';
            if (hour < 17) return '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡∏ö‡πà‡∏≤‡∏¢';
            if (hour < 20) return '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡πÄ‡∏¢‡πá‡∏ô';
            return '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡∏Ñ‡πà‡∏≥';
        }
        
        // Update date and time
        function updateDateTime() {
            const now = new Date();
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            document.getElementById('currentDateTime').textContent = 
                now.toLocaleDateString('th-TH', options);
        }
        
        // Show dashboard elements
        function showDashboardElements() {
            document.getElementById('dashboardStats').style.display = 'grid';
            document.getElementById('progressOverview').style.display = 'block';
        }
        
        // Show welcome completion message
        function showWelcomeMessage() {
            if (userInfo) {
                showToast(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${userInfo.username}! ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`, 'success');
            }
        }
        
        // Check if user is authenticated
        function checkAuthentication() {
            const token = localStorage.getItem('token');
            console.log('Checking authentication, token present:', !!token);
            
            // Debug: Show token info
            if (token) {
                try {
                    const tokenParts = token.split('.');
                    if (tokenParts.length === 3) {
                        const payload = JSON.parse(atob(tokenParts[1]));
                        console.log('Token payload:', payload);
                        console.log('Token expires:', new Date(payload.exp * 1000));
                        
                        // Check if token is expired
                        if (payload.exp && payload.exp * 1000 < Date.now()) {
                            console.log('Token is expired, redirecting to login');
                            localStorage.removeItem('token');
                            window.location.href = 'index.html';
                            return;
                        }
                    }
                } catch (e) {
                    console.error('Invalid token format:', e);
                    localStorage.removeItem('token');
                    window.location.href = 'index.html';
                    return;
                }
            }
            
            if (!token) {
                console.log('No token found, redirecting to login');
                window.location.href = 'index.html';
                return;
            }
            console.log('Token found, proceeding with authentication');
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Search functionality
            document.getElementById('searchInput').addEventListener('input', function(e) {
                searchTasks(e.target.value);
            });
            
            // Close modals when clicking outside
            document.getElementById('taskModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeTaskModal();
                }
            });
            
            document.getElementById('deleteModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeDeleteModal();
                }
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeTaskModal();
                    closeDeleteModal();
                }
                if (e.ctrlKey && e.key === 'n') {
                    e.preventDefault();
                    openAddTaskModal();
                }
            });
        }
        
        // API Functions
        async function apiRequest(endpoint, options = {}) {
            const token = localStorage.getItem('token');
            const url = `${API_BASE_URL}${endpoint}`;
            
            console.log('Making API request to:', url);
            console.log('Token:', token ? 'Present' : 'Missing');
            console.log('Endpoint:', endpoint);
            
            if (!token) {
                console.error('No authentication token found');
                throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö token ‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
            }
            
            const defaultOptions = {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            };
            
            const finalOptions = { ...defaultOptions, ...options };
            if (options.headers) {
                finalOptions.headers = { ...defaultOptions.headers, ...options.headers };
            }
            
            console.log('Request options:', finalOptions);
            
            try {
                const response = await fetch(url, finalOptions);
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (response.status === 401) {
                    console.log('Unauthorized - removing token and redirecting');
                    localStorage.removeItem('token');
                    window.location.href = 'index.html';
                    return null;
                }
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('API Error Response:', errorData);
                    throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                const responseData = await response.json();
                console.log('API Success Response:', responseData);
                return responseData;
            } catch (error) {
                console.error('API Request Error:', error);
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï', 'error');
                } else {
                    showToast(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
                }
                throw error;
            }
        }
        
        // Load tasks from API
        async function loadTasks() {
            try {
                showLoading(true);
                console.log('Starting to load tasks...');
                
                // Show loading message in welcome section
                const welcomeSubtext = document.getElementById('welcomeSubtext');
                if (welcomeSubtext) {
                    welcomeSubtext.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì... üìä';
                }
                
                console.log('Making API request to /tasks');
                const data = await apiRequest('/tasks');
                console.log('API response:', data);
                
                if (data && data.tasks) {
                    allTasks = data.tasks;
                    filteredTasks = [...allTasks];
                    console.log('Tasks loaded successfully:', allTasks.length, 'tasks');
                    
                    // Update welcome message
                    if (welcomeSubtext && userInfo) {
                        const taskCount = allTasks.length;
                        welcomeSubtext.textContent = `‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏á‡∏≤‡∏ô ${taskCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á? üí™`;
                    }
                    
                    applySorting();
                    updateTaskCounts();
                    renderTasks();
                    
                    // Show motivational message based on tasks
                    showMotivationalMessage();
                } else if (data && data.data) {
                    // Handle alternative response structure
                    allTasks = data.data || [];
                    filteredTasks = [...allTasks];
                    console.log('Tasks loaded successfully (alternative structure):', allTasks.length, 'tasks');
                    
                    applySorting();
                    updateTaskCounts();
                    renderTasks();
                    showMotivationalMessage();
                } else {
                    // No tasks or empty response
                    console.log('No tasks found or empty response:', data);
                    allTasks = [];
                    filteredTasks = [];
                    
                    if (welcomeSubtext && userInfo) {
                        welcomeSubtext.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏¢! üöÄ';
                    }
                    
                    updateTaskCounts();
                    renderTasks();
                    
                    // Show helpful message for new users
                    setTimeout(() => {
                        showToast('üéØ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö! ‡∏Ñ‡∏•‡∏¥‡∏Å "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì', 'info');
                    }, 2000);
                }
            } catch (error) {
                console.error('Failed to load tasks:', error);
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ: ' + error.message, 'error');
                
                // Update welcome message for error
                const welcomeSubtext = document.getElementById('welcomeSubtext');
                if (welcomeSubtext) {
                    welcomeSubtext.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á üòû';
                }
            } finally {
                showLoading(false);
                isDataLoaded = true;
            }
        }
        
        // Show motivational message based on task status
        function showMotivationalMessage() {
            const completed = allTasks.filter(t => t.status === 'completed').length;
            const total = allTasks.length;
            const overdue = allTasks.filter(t => 
                t.due_date && new Date(t.due_date) < new Date() && t.status !== 'completed'
            ).length;
            
            setTimeout(() => {
                if (total === 0) {
                    showToast('üéâ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà! ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏¢', 'info');
                } else if (completed === total) {
                    showToast('üéä ‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß!', 'success');
                } else if (overdue > 0) {
                    showToast(`‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î ${overdue} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏µ‡∏ö‡∏ó‡∏≥‡∏î‡πà‡∏ß‡∏ô!`, 'warning');
                } else {
                    const remaining = total - completed;
                    showToast(`üí™ ‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡πÑ‡∏î‡πâ! ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å ${remaining} ‡∏á‡∏≤‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô`, 'info');
                }
            }, 2000);
        }
        
        // Create new task
        async function createTask(taskData) {
            try {
                const data = await apiRequest('/tasks', {
                    method: 'POST',
                    body: JSON.stringify(taskData)
                });
                
                if (data && data.task) {
                    allTasks.unshift(data.task);
                    applyFilters();
                    showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                    return data.task;
                }
            } catch (error) {
                throw error;
            }
        }
        
        // Update task
        async function updateTask(taskId, taskData) {
            try {
                const data = await apiRequest(`/tasks/${taskId}`, {
                    method: 'PATCH',
                    body: JSON.stringify(taskData)
                });
                
                if (data && data.task) {
                    const index = allTasks.findIndex(task => task.id === taskId);
                    if (index !== -1) {
                        allTasks[index] = data.task;
                        applyFilters();
                        showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                        return data.task;
                    }
                }
            } catch (error) {
                throw error;
            }
        }
        
        // Delete task
        async function deleteTask(taskId) {
            try {
                await apiRequest(`/tasks/${taskId}`, {
                    method: 'DELETE'
                });
                
                allTasks = allTasks.filter(task => task.id !== taskId);
                applyFilters();
                showToast('‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
            } catch (error) {
                throw error;
            }
        }
        
        // Toggle task completion
        async function toggleTaskCompletion(taskId, completed) {
            try {
                const endpoint = completed ? `/tasks/${taskId}/complete` : `/tasks/${taskId}`;
                const body = completed ? {} : { status: 'pending' };
                
                const data = await apiRequest(endpoint, {
                    method: 'PATCH',
                    body: JSON.stringify(body)
                });
                
                if (data && data.task) {
                    const index = allTasks.findIndex(task => task.id === taskId);
                    if (index !== -1) {
                        allTasks[index] = data.task;
                        applyFilters();
                        
                        // Show encouraging message
                        if (completed) {
                            const completedCount = allTasks.filter(t => t.is_completed || t.status === 'completed').length;
                            const totalCount = allTasks.length;
                            
                            if (completedCount === totalCount) {
                                showToast('üéâ ‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß!', 'success');
                            } else {
                                const encouragingMessages = [
                                    'üéØ ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å! ‡∏ó‡∏≥‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡πÄ‡∏•‡∏¢',
                                    'üí™ ‡∏î‡∏µ‡∏°‡∏≤‡∏Å! ‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡πÑ‡∏î‡πâ',
                                    '‚≠ê ‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î! ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏£‡∏≠‡∏≠‡∏¢‡∏π‡πà',
                                    'üöÄ ‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å! ‡∏°‡∏∏‡πà‡∏á‡πÑ‡∏õ‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤',
                                    'üåü ‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß'
                                ];
                                const randomMessage = encouragingMessages[Math.floor(Math.random() * encouragingMessages.length)];
                                showToast(randomMessage, 'success');
                            }
                        } else {
                            showToast('‚úèÔ∏è ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'info');
                        }
                    }
                }
            } catch (error) {
                console.error('Failed to toggle task:', error);
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ', 'error');
            }
        }
        
        // UI Functions
        function showLoading(show) {
            const loadingState = document.getElementById('loadingState');
            const tasksContainer = document.getElementById('tasksContainer');
            
            if (show) {
                loadingState.style.display = 'block';
                tasksContainer.classList.add('loading');
            } else {
                loadingState.style.display = 'none';
                tasksContainer.classList.remove('loading');
            }
        }
        
        function renderTasks() {
            const container = document.getElementById('tasksContainer');
            const emptyState = document.getElementById('emptyState');
            const loadingState = document.getElementById('loadingState');
            
            // Hide loading state
            loadingState.style.display = 'none';
            
            if (filteredTasks.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            container.style.display = 'grid';
            emptyState.style.display = 'none';
            
            container.innerHTML = filteredTasks.map(task => createTaskCard(task)).join('');
        }
        
        function createTaskCard(task) {
            const isOverdue = task.due_date && new Date(task.due_date) < new Date() && !task.is_completed;
            const isCompleted = task.is_completed || task.status === 'completed';
            
            // Convert priority to string for CSS classes
            const priorityStringMap = {
                1: 'low',
                2: 'medium',
                3: 'high'
            };
            const priorityString = priorityStringMap[task.priority] || task.priority || 'low';
            const priorityClass = `priority-${priorityString}`;
            const cardClass = isCompleted ? 'completed' : (isOverdue ? 'overdue' : '');
            
            const dueDateText = task.due_date ? formatDate(task.due_date) : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≥‡∏´‡∏ô‡∏î';
            const categoryBadge = task.category ? 
                `<span class="category-badge bg-blue-100 text-blue-800">${task.category}</span>` : '';
            
            // Handle both is_completed (boolean) and status (string) for backward compatibility
            const status = isCompleted ? 'completed' : (task.status || 'pending');
            const statusText = getStatusText(status);
            const statusClass = `status-${status}`;
            
            // Enhanced priority indicator
            const priorityIcon = getPriorityIcon(task.priority);
            const priorityText = getPriorityText(task.priority);
            
            // Status emoji
            const statusEmoji = getStatusEmoji(status);
            
            // Recurring indicator
            const recurringBadge = task.is_recurring ? 
                `<span class="recurring-badge bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded">üîÑ ${task.recurring_frequency || '‡∏ó‡∏≥‡∏ã‡πâ‡∏≥'}</span>` : '';
            
            return `
                <div class="task-card ${priorityClass} ${cardClass} rounded-lg p-4 fade-in">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <input type="checkbox" class="task-checkbox" 
                                   ${isCompleted ? 'checked' : ''} 
                                   onchange="toggleTaskCompletion('${task.id}', this.checked)">
                            <div>
                                <h3 class="font-semibold text-gray-900 ${isCompleted ? 'line-through' : ''}">${task.task_name || task.title}</h3>
                                <div class="flex items-center gap-2 mt-1">
                                    ${categoryBadge}
                                    ${recurringBadge}
                                    <span class="text-xs text-gray-500">${priorityIcon} ${priorityText}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="editTask('${task.id}')" 
                                    class="text-gray-400 hover:text-blue-500 p-1 rounded transition-colors" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="openDeleteModal('${task.id}')" 
                                    class="text-gray-400 hover:text-red-500 p-1 rounded transition-colors" title="‡∏•‡∏ö">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    ${task.description ? `<p class="text-gray-600 text-sm mb-3 leading-relaxed">${task.description}</p>` : ''}
                    
                    <div class="flex justify-between items-center text-xs">
                        <div class="flex items-center gap-2">
                            <span class="${statusClass} font-medium flex items-center gap-1">
                                ${statusEmoji} ${statusText}
                            </span>
                        </div>
                        <div class="flex items-center gap-1 ${isOverdue ? 'text-red-500 font-medium' : 'text-gray-500'}">
                            <i class="fas fa-calendar"></i>
                            <span>${dueDateText}</span>
                        </div>
                    </div>
                    
                    ${isOverdue ? '<div class="mt-2 text-xs text-red-500 font-medium flex items-center gap-1"><i class="fas fa-exclamation-triangle"></i> ‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏•‡πâ‡∏ß!</div>' : ''}
                </div>
            `;
        }
        
        // Get priority icon
        function getPriorityIcon(priority) {
            // Handle both integer (from API) and string (legacy) formats
            const icons = {
                1: 'üü¢',
                2: 'üü°',
                3: 'üî¥',
                'low': 'üü¢',
                'medium': 'üü°', 
                'high': 'ÔøΩ'
            };
            return icons[priority] || 'üü¢';
        }
        
        // Get status emoji
        function getStatusEmoji(status) {
            const emojis = {
                pending: '‚è≥',
                'in-progress': 'üîÑ',
                completed: '‚úÖ',
                cancelled: '‚ùå'
            };
            return emojis[status] || '‚è≥';
        }
        
        // Modal Functions
        function openAddTaskModal() {
            isEditing = false;
            document.getElementById('modalTitle').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà';
            document.getElementById('taskForm').reset();
            document.getElementById('taskId').value = '';
            
            // Reset category selection
            document.getElementById('taskCategorySelect').value = '';
            document.getElementById('taskCategory').style.display = 'none';
            document.getElementById('taskCategory').value = '';
            
            document.getElementById('taskModal').style.display = 'flex';
            document.getElementById('taskTitle').focus();
        }
        
        function editTask(taskId) {
            const task = allTasks.find(t => t.id === taskId);
            if (!task) return;
            
            // Convert priority from integer (API) to string (form)
            const priorityReverseMap = {
                1: 'low',
                2: 'medium', 
                3: 'high'
            };
            
            isEditing = true;
            document.getElementById('modalTitle').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô';
            document.getElementById('taskId').value = task.id;
            document.getElementById('taskTitle').value = task.task_name || task.title || '';
            document.getElementById('taskDescription').value = task.description || '';
            document.getElementById('taskPriority').value = priorityReverseMap[task.priority] || 'low';
            
            // Handle recurring task fields
            document.getElementById('taskRecurring').checked = task.is_recurring || false;
            if (task.is_recurring) {
                document.getElementById('recurringOptions').style.display = 'block';
                document.getElementById('taskRecurringFrequency').value = task.recurring_frequency || '';
            } else {
                document.getElementById('recurringOptions').style.display = 'none';
                document.getElementById('taskRecurringFrequency').value = '';
            }
            
            // Handle category selection
            const categorySelect = document.getElementById('taskCategorySelect');
            const categoryInput = document.getElementById('taskCategory');
            
            if (task.category) {
                // Check if category exists in predefined options
                const option = categorySelect.querySelector(`option[value="${task.category}"]`);
                if (option) {
                    categorySelect.value = task.category;
                    categoryInput.style.display = 'none';
                    categoryInput.value = '';
                } else {
                    // Custom category
                    categorySelect.value = 'custom';
                    categoryInput.style.display = 'block';
                    categoryInput.value = task.category;
                }
            } else {
                categorySelect.value = '';
                categoryInput.style.display = 'none';
                categoryInput.value = '';
            }
            
            if (task.due_date) {
                // Fix date format for date input
                const date = new Date(task.due_date);
                if (!isNaN(date.getTime())) {
                    // Format as YYYY-MM-DD for date input
                    document.getElementById('taskDueDate').value = date.toISOString().slice(0, 10);
                }
            } else {
                document.getElementById('taskDueDate').value = '';
            }
            
            document.getElementById('taskModal').style.display = 'flex';
            document.getElementById('taskTitle').focus();
        }
        
        // Handle category selection
        function handleCategorySelect() {
            const categorySelect = document.getElementById('taskCategorySelect');
            const categoryInput = document.getElementById('taskCategory');
            
            if (categorySelect.value === 'custom') {
                categoryInput.style.display = 'block';
                categoryInput.focus();
                categoryInput.placeholder = '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà...';
            } else {
                categoryInput.style.display = 'none';
                categoryInput.value = '';
            }
        }

        function toggleRecurringOptions() {
            const recurringCheckbox = document.getElementById('taskRecurring');
            const recurringOptions = document.getElementById('recurringOptions');
            
            if (recurringCheckbox.checked) {
                recurringOptions.style.display = 'block';
            } else {
                recurringOptions.style.display = 'none';
                document.getElementById('taskRecurringFrequency').value = '';
            }
        }
        
        function closeTaskModal() {
            document.getElementById('taskModal').style.display = 'none';
            document.getElementById('taskForm').reset();
            
            // Reset category selection
            document.getElementById('taskCategorySelect').value = '';
            document.getElementById('taskCategory').style.display = 'none';
            document.getElementById('taskCategory').value = '';
            
            // Reset recurring options
            document.getElementById('taskRecurring').checked = false;
            document.getElementById('recurringOptions').style.display = 'none';
            document.getElementById('taskRecurringFrequency').value = '';
            
            // Reset modal title and editing state
            document.getElementById('modalTitle').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà';
            isEditing = false;
        }
        
        function openDeleteModal(taskId) {
            taskToDelete = taskId;
            document.getElementById('deleteModal').style.display = 'flex';
        }
        
        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            taskToDelete = null;
        }
        
        async function confirmDelete() {
            if (taskToDelete) {
                try {
                    await deleteTask(taskToDelete);
                    closeDeleteModal();
                } catch (error) {
                    console.error('Failed to delete task:', error);
                }
            }
        }
        
        // Form handling
        async function saveTask(event) {
            event.preventDefault();
            
            // Get category value
            const categorySelect = document.getElementById('taskCategorySelect');
            const categoryInput = document.getElementById('taskCategory');
            let categoryValue = '';
            
            if (categorySelect.value === 'custom') {
                categoryValue = categoryInput.value.trim();
            } else if (categorySelect.value) {
                categoryValue = categorySelect.value;
            }
            
            // Handle due date - ensure proper format for date only
            let dueDateValue = null;
            const dueDateInput = document.getElementById('taskDueDate').value;
            if (dueDateInput) {
                try {
                    // For date input, we get YYYY-MM-DD format
                    // Create date at noon to avoid timezone issues
                    const date = new Date(dueDateInput + 'T12:00:00');
                    if (!isNaN(date.getTime())) {
                        dueDateValue = date.toISOString();
                    }
                } catch (error) {
                    console.error('Invalid date format:', error);
                    showToast('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                    return;
                }
            }
            
            // Convert priority from string to integer
            const priorityMap = {
                'low': 1,
                'medium': 2,
                'high': 3
            };
            
            const formData = {
                task_name: document.getElementById('taskTitle').value.trim(),
                description: document.getElementById('taskDescription').value.trim() || null,
                priority: priorityMap[document.getElementById('taskPriority').value] || 1,
                category: categoryValue || null,
                due_date: dueDateValue,
                is_recurring: document.getElementById('taskRecurring').checked,
                recurring_frequency: document.getElementById('taskRecurring').checked ? 
                    document.getElementById('taskRecurringFrequency').value || null : null
            };
            
            if (!formData.task_name) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô', 'error');
                document.getElementById('taskTitle').focus();
                return;
            }
            
            // Show loading state on submit button
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            submitBtn.disabled = true;
            
            try {
                const taskId = document.getElementById('taskId').value;
                
                if (isEditing && taskId) {
                    await updateTask(taskId, formData);
                } else {
                    await createTask(formData);
                }
                
                closeTaskModal();
            } catch (error) {
                console.error('Failed to save task:', error);
                // Error message will be shown by apiRequest function
            } finally {
                // Restore button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }
        
        // Filter and search functions
        function setFilter(filter) {
            currentFilter = filter;
            
            // Update active filter tab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
            
            applyFilters();
        }
        
        function applyFilters() {
            let filtered = [...allTasks];
            
            // Apply status filter
            if (currentFilter !== 'all') {
                if (currentFilter === 'overdue') {
                    filtered = filtered.filter(task => {
                        return task.due_date && 
                               new Date(task.due_date) < new Date() && 
                               !task.is_completed && task.status !== 'completed';
                    });
                } else if (currentFilter === 'completed') {
                    filtered = filtered.filter(task => task.is_completed || task.status === 'completed');
                } else if (currentFilter === 'pending') {
                    filtered = filtered.filter(task => !task.is_completed && (task.status === 'pending' || !task.status));
                } else {
                    filtered = filtered.filter(task => task.status === currentFilter);
                }
            }
            
            // Apply search filter
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(task => 
                    (task.task_name || task.title || '').toLowerCase().includes(searchTerm) ||
                    (task.description && task.description.toLowerCase().includes(searchTerm)) ||
                    (task.category && task.category.toLowerCase().includes(searchTerm))
                );
            }
            
            filteredTasks = filtered;
            applySorting();
            updateTaskCounts();
            renderTasks();
        }
        
        function searchTasks(searchTerm) {
            applyFilters();
        }
        
        function applySorting() {
            const sortBy = document.getElementById('sortBy').value;
            const sortOrder = document.getElementById('sortOrder').value;
            
            currentSort = { by: sortBy, order: sortOrder };
            
            filteredTasks.sort((a, b) => {
                let aVal, bVal;
                
                switch (sortBy) {
                    case 'due_date':
                        aVal = a.due_date ? new Date(a.due_date) : new Date('2099-12-31');
                        bVal = b.due_date ? new Date(b.due_date) : new Date('2099-12-31');
                        break;
                    case 'priority':
                        // Handle both integer (1,2,3) and string ('low','medium','high') priority values
                        const priorityOrder = { 
                            1: 1, 2: 2, 3: 3,  // integer values from API
                            'low': 1, 'medium': 2, 'high': 3  // legacy string values
                        };
                        aVal = priorityOrder[a.priority] || 1;
                        bVal = priorityOrder[b.priority] || 1;
                        break;
                    case 'title':
                        aVal = (a.task_name || a.title || '').toLowerCase();
                        bVal = (b.task_name || b.title || '').toLowerCase();
                        break;
                    default: // created_at
                        aVal = new Date(a.created_at);
                        bVal = new Date(b.created_at);
                }
                
                if (sortOrder === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            renderTasks();
        }
        
        // Helper functions
        function updateTaskCounts() {
            const counts = {
                all: allTasks.length,
                pending: allTasks.filter(t => !t.is_completed && (t.status === 'pending' || !t.status)).length,
                'in-progress': allTasks.filter(t => !t.is_completed && t.status === 'in-progress').length,
                completed: allTasks.filter(t => t.is_completed || t.status === 'completed').length,
                overdue: allTasks.filter(t => 
                    t.due_date && new Date(t.due_date) < new Date() && !t.is_completed && t.status !== 'completed'
                ).length
            };
            
            // Update filter counts
            Object.keys(counts).forEach(key => {
                const element = document.getElementById(`count-${key}`);
                if (element) {
                    element.textContent = counts[key];
                }
            });
            
            // Update dashboard stats with animations
            updateDashboardStats(counts);
            updateProgressOverview(counts);
        }
        
        // Update dashboard statistics with beautiful animations
        function updateDashboardStats(counts) {
            // Animate pending count
            animateCounter('pendingCount', counts.pending, '‚è≥');
            
            // Animate in-progress count
            animateCounter('inProgressCount', counts['in-progress'], 'üîÑ');
            
            // Animate completed count
            animateCounter('completedCount', counts.completed, '‚úÖ');
            
            // Animate overdue count
            animateCounter('overdueCount', counts.overdue, '‚ö†Ô∏è');
        }
        
        // Update progress overview
        function updateProgressOverview(counts) {
            const total = counts.all;
            const completed = counts.completed;
            const progressPercentage = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            // Update overall progress
            document.getElementById('overallProgress').textContent = `${progressPercentage}%`;
            document.getElementById('overallProgressBar').style.width = `${progressPercentage}%`;
            
            // Update today's tasks
            const today = new Date();
            const todayTasks = allTasks.filter(task => {
                if (!task.due_date) return false;
                const taskDate = new Date(task.due_date);
                return taskDate.toDateString() === today.toDateString();
            });
            
            const todayCompleted = todayTasks.filter(task => task.is_completed || task.status === 'completed').length;
            const todayRemaining = todayTasks.length - todayCompleted;
            
            animateCounter('todayTotal', todayTasks.length);
            animateCounter('todayCompleted', todayCompleted);
            animateCounter('todayRemaining', todayRemaining);
        }
        
        // Animate counter with smooth transition
        function animateCounter(elementId, targetValue, emoji = '') {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const startValue = parseInt(element.textContent) || 0;
            const duration = 1000; // 1 second
            const increment = (targetValue - startValue) / (duration / 16); // 60fps
            let currentValue = startValue;
            
            const timer = setInterval(() => {
                currentValue += increment;
                if ((increment > 0 && currentValue >= targetValue) || 
                    (increment < 0 && currentValue <= targetValue)) {
                    currentValue = targetValue;
                    clearInterval(timer);
                }
                element.textContent = Math.round(currentValue);
                
                // Add pulsing effect for completed animations
                if (currentValue === targetValue && targetValue > 0) {
                    element.style.animation = 'pulse 0.5s ease-in-out';
                    setTimeout(() => {
                        element.style.animation = '';
                    }, 500);
                }
            }, 16);
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = date - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) {
                return `‡πÄ‡∏Å‡∏¥‡∏ô ${Math.abs(diffDays)} ‡∏ß‡∏±‡∏ô`;
            } else if (diffDays === 0) {
                return '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ';
            } else if (diffDays === 1) {
                return '‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ';
            } else {
                return `‡∏≠‡∏µ‡∏Å ${diffDays} ‡∏ß‡∏±‡∏ô`;
            }
        }
        
        function getStatusText(status) {
            const statusMap = {
                pending: '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
                'in-progress': '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥',
                completed: '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß',
                cancelled: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            };
            return statusMap[status] || status;
        }
        
        function getPriorityText(priority) {
            // Handle both integer (from API) and string (legacy) formats
            const priorityMap = {
                1: '‡∏ï‡πà‡∏≥',
                2: '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á', 
                3: '‡∏™‡∏π‡∏á',
                'low': '‡∏ï‡πà‡∏≥',
                'medium': '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á',
                'high': '‡∏™‡∏π‡∏á'
            };
            return priorityMap[priority] || '‡∏ï‡πà‡∏≥';
        }
        
        // Toast notification function with enhanced styling
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const iconMap = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            toast.className = `
                p-4 rounded-xl shadow-lg text-white mb-3 w-full max-w-sm
                transform transition-all duration-500 translate-x-full opacity-0
                ${type === 'error' ? 'bg-gradient-to-r from-red-500 to-red-600 border-l-4 border-red-700' : 
                  type === 'success' ? 'bg-gradient-to-r from-green-500 to-green-600 border-l-4 border-green-700' : 
                  type === 'warning' ? 'bg-gradient-to-r from-yellow-500 to-yellow-600 border-l-4 border-yellow-700' :
                  'bg-gradient-to-r from-blue-500 to-blue-600 border-l-4 border-blue-700'}
            `;
            
            toast.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <span class="text-lg">${iconMap[type]}</span>
                        <span class="font-medium flex-1">${message}</span>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200 opacity-70 hover:opacity-100 transition-opacity">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            `;
            
            const container = document.getElementById('toast-container');
            container.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
            }, 100);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (container.contains(toast)) {
                    toast.classList.add('translate-x-full', 'opacity-0');
                    setTimeout(() => {
                        if (container.contains(toast)) {
                            container.removeChild(toast);
                        }
                    }, 500);
                }
            }, 5000);
            
            return toast;
        }
    </script>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2 max-w-sm"></div>
</body>
</html>
