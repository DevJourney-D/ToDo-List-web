<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ToDo List</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÖ</text></svg>">
    <link href="./dist/styles.css" rel="stylesheet">
    <style>
        .excel-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .excel-card { background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); }
        .stats-widget { padding: 20px; text-align: center; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="excel-bg">
    <div id="app" class="min-h-screen">
        <div id="nav-container"></div>
        
        <div class="container mx-auto p-6">
            <div id="content" class="fade-in">
                <!-- Loading state -->
                <div id="loading-state" class="text-center text-white py-20">
                    <div class="loading-spinner mb-4"></div>
                    <p class="text-lg">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Dashboard...</p>
                    <p class="text-sm opacity-75 mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>
                </div>
                
                <!-- Dashboard content will be loaded here -->
                <div id="dashboard-content" style="display: none;"></div>
                
                <!-- Error state -->
                <div id="error-state" style="display: none;" class="text-center text-white py-20">
                    <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                    <h2 class="text-2xl font-bold mb-4">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h2>
                    <p class="text-lg mb-6">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                    <button onclick="location.reload()" class="bg-white text-blue-600 px-6 py-3 rounded-lg font-medium hover:bg-gray-100 transition-colors">
                        ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2 max-w-sm"></div>

    <!-- Shared API Manager -->
    <script src="shared-api.js"></script>
    <!-- Navigation Component -->
    <script src="nav-component.js"></script>

    <script>
        // Global state
        let currentUser = null;
        let isLoading = false;

        // Utility functions
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const iconMap = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
            
            toast.className = `p-4 rounded-xl shadow-lg text-white mb-3 w-full max-w-sm transform transition-all duration-500 translate-x-full opacity-0 ${
                type === 'error' ? 'bg-gradient-to-r from-red-500 to-red-600' : 
                type === 'success' ? 'bg-gradient-to-r from-green-500 to-green-600' : 
                type === 'warning' ? 'bg-gradient-to-r from-yellow-500 to-yellow-600' :
                'bg-gradient-to-r from-blue-500 to-blue-600'
            }`;
            
            toast.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <span class="text-lg">${iconMap[type]}</span>
                        <span class="font-medium">${message}</span>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">√ó</button>
                </div>
            `;
            
            const container = document.getElementById('toast-container');
            container.appendChild(toast);
            
            setTimeout(() => toast.classList.remove('translate-x-full', 'opacity-0'), 100);
            setTimeout(() => {
                if (container.contains(toast)) {
                    toast.classList.add('translate-x-full', 'opacity-0');
                    setTimeout(() => container.contains(toast) && container.removeChild(toast), 500);
                }
            }, 5000);
        }

        // Show/hide loading state
        function showLoading() {
            document.getElementById('loading-state').style.display = 'block';
            document.getElementById('dashboard-content').style.display = 'none';
            document.getElementById('error-state').style.display = 'none';
        }

        function showContent() {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('dashboard-content').style.display = 'block';
            document.getElementById('error-state').style.display = 'none';
        }

        function showError() {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('dashboard-content').style.display = 'none';
            document.getElementById('error-state').style.display = 'block';
        }

        // Render dashboard with optimized data loading
        function renderDashboard(userInfo, tasks, summary, isEmpty = false) {
            const content = document.getElementById('dashboard-content');
            
            // Calculate stats
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(t => t.is_completed).length;
            const pendingTasks = totalTasks - completedTasks;
            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            // Get today's tasks using DateUtils
            const todayTasks = tasks.filter(task => {
                if (!task.due_date) return false;
                return window.dateUtils.isToday(task.due_date);
            });
            
            // Get overdue tasks using DateUtils
            const overdueTasks = tasks.filter(task => {
                if (!task.due_date || task.is_completed) return false;
                return window.dateUtils.isOverdue(task.due_date);
            });

            // Pagination config for today's tasks
            const pageSize = 5;
            let currentPage = window.todayTasksPage || 1;
            const totalPages = Math.ceil(todayTasks.length / pageSize);
            const paginatedTodayTasks = todayTasks.slice((currentPage - 1) * pageSize, currentPage * pageSize);
            
            if (isEmpty) {
                content.innerHTML = `
                    <div class="excel-card p-8 text-center">
                        <div class="text-4xl mb-3">üì≠</div>
                        <h3 class="text-lg font-medium text-gray-700 mb-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô</h3>
                        <p class="text-gray-500">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!</p>
                        <a href="tasks.html" class="mt-4 inline-block bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</a>
                    </div>
                `;
                return;
            }
            
            content.innerHTML = `
                <!-- Header -->
                <div class="excel-card p-6 mb-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-800 mb-2">
                                ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ${userInfo.user?.username || 'User'}! üëã
                            </h1>
                            <p class="text-gray-600">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà Dashboard ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-blue-600">${completionRate}%</div>
                            <div class="text-sm text-gray-500">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
                        </div>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="excel-card stats-widget">
                        <div class="text-3xl font-bold text-blue-600 mb-2">${totalTasks}</div>
                        <div class="text-gray-600">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                    </div>
                    <div class="excel-card stats-widget">
                        <div class="text-3xl font-bold text-green-600 mb-2">${completedTasks}</div>
                        <div class="text-gray-600">‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</div>
                    </div>
                    <div class="excel-card stats-widget">
                        <div class="text-3xl font-bold text-yellow-600 mb-2">${pendingTasks}</div>
                        <div class="text-gray-600">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
                    </div>
                    <div class="excel-card stats-widget">
                        <div class="text-3xl font-bold text-red-600 mb-2">${overdueTasks.length}</div>
                        <div class="text-gray-600">‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î</div>
                    </div>
                </div>

                <!-- Today's Tasks -->
                <div class="excel-card p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                                <span class="text-blue-600 text-lg">üìã</span>
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2>
                                <p class="text-gray-600 text-sm">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                            </div>
                        </div>
                        <span class="bg-blue-500 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg">
                            ${todayTasks.length} ‡∏á‡∏≤‡∏ô
                        </span>
                    </div>
                    
                    ${todayTasks.length === 0 ? 
                        '<div class="text-center text-gray-500 py-12 border-2 border-dashed border-gray-200 rounded-lg"><div class="text-4xl mb-3">üéâ</div><h3 class="text-lg font-medium text-gray-700 mb-2">‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°!</h3><p class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p></div>' :
                        `<div class="space-y-3">
                            ${paginatedTodayTasks.map((task, index) => `
                                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-4">
                                            <div class="flex items-center space-x-3">
                                                <span class="text-gray-400 font-mono text-sm">${String((currentPage - 1) * pageSize + index + 1).padStart(2, '0')}</span>
                                                <input type="checkbox" ${task.is_completed ? 'checked' : ''} 
                                                       onchange="toggleTask('${task.id}', this.checked)"
                                                       class="w-5 h-5 text-blue-600 rounded">
                                            </div>
                                            <div class="flex-1">
                                                <span class="font-medium text-lg ${task.is_completed ? 'line-through text-gray-500' : 'text-gray-800'}">
                                                    ${task.task_name || task.title || 'Untitled Task'}
                                                </span>
                                                ${task.description ? `<p class="text-gray-500 text-sm mt-1">${task.description}</p>` : ''}
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-3">
                                            <span class="priority-badge priority-${task.priority === 3 ? 'high' : task.priority === 2 ? 'medium' : 'low'}">
                                                ${task.priority === 3 ? 'üî• ‡∏™‡∏π‡∏á' : task.priority === 2 ? '‚ö° ‡∏Å‡∏•‡∏≤‡∏á' : 'üìù ‡∏ï‡πà‡∏≥'}
                                            </span>
                                            ${task.due_date ? `<span class="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded">
                                                üìÖ ${window.dateUtils.formatThaiDate(task.due_date)}
                                            </span>` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="flex justify-center items-center gap-2 mt-4">
                            <button class="px-3 py-1 rounded bg-gray-200 text-gray-700 font-medium" ${currentPage === 1 ? 'disabled' : ''} onclick="window.todayTasksPage=${currentPage - 1};document.querySelector('#dashboard-content').scrollIntoView({behavior:'smooth'});setTimeout(()=>{window.lastTasks=tasks;window.currentUser=userInfo;renderDashboard(userInfo, tasks, summary)},100)">&lt; ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
                            <span class="px-2">‡∏´‡∏ô‡πâ‡∏≤ ${currentPage} / ${totalPages}</span>
                            <button class="px-3 py-1 rounded bg-gray-200 text-gray-700 font-medium" ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''} onclick="window.todayTasksPage=${currentPage + 1};document.querySelector('#dashboard-content').scrollIntoView({behavior:'smooth'});setTimeout(()=>{window.lastTasks=tasks;window.currentUser=userInfo;renderDashboard(userInfo, tasks, summary)},100)">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ &gt;</button>
                        </div>`
                    }
                    
                    ${todayTasks.length > 0 ? `
                        <div class="mt-6 pt-4 border-t border-gray-200">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-600">
                                    ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß: <span class="font-medium">${todayTasks.filter(t => t.is_completed).length}</span> ‡∏à‡∏≤‡∏Å ${todayTasks.length} ‡∏á‡∏≤‡∏ô
                                </span>
                                <a href="tasks.html" class="text-blue-600 hover:text-blue-800 font-medium">
                                    ‡∏î‡∏π‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Üí
                                </a>
                            </div>
                        </div>
                    ` : ''}
                </div>
                </div>

                <!-- Recent Activity -->
                <div class="excel-card p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
                    <div class="space-y-3">
                        ${tasks.slice(-5).reverse().map(task => `
                            <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                                <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                                <div class="flex-1">
                                    <span class="font-medium text-gray-800">${task.task_name || task.title || 'Untitled Task'}</span>
                                    <span class="text-gray-500 text-sm ml-2">
                                        ${task.is_completed ? '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' : '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà'}
                                    </span>
                                </div>
                                <span class="text-xs text-gray-400">
                                    ${task.created_at ? window.dateUtils.formatThaiDate(task.created_at.split('T')[0]) : '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ'}
                                </span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            // Add priority badge styles
            const style = document.createElement('style');
            style.textContent = `
                .priority-badge { font-size: 0.75rem; padding: 2px 8px; border-radius: 12px; font-weight: 500; }
                .priority-high { background: #fee2e2; color: #dc2626; }
                .priority-medium { background: #fef3c7; color: #d97706; }
                .priority-low { background: #d1fae5; color: #059669; }
            `;
            document.head.appendChild(style);
        }

        // Toggle task completion
        async function toggleTask(taskId, isCompleted) {
            try {
                await window.apiManager.apiCall(`/tasks/${taskId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ is_completed: isCompleted })
                });
                
                showToast(isCompleted ? '‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß!' : '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß', 'success');
                
                // Refresh data
                window.dataManager.clearCache();
                loadDashboard();
            } catch (error) {
                console.error('Error updating task:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏á‡∏≤‡∏ô', 'error');
            }
        }

        // Main function to load dashboard
        async function loadDashboard() {
            if (isLoading) return;
            isLoading = true;
            try {
                showLoading();
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = 'index.html';
                    return;
                }
                const isConnected = await window.apiManager.testConnection();
                if (!isConnected) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ');
                }
                // Load data using shared data manager
                const [userInfo, tasks] = await Promise.all([
                    window.dataManager.loadUserInfo(),
                    window.dataManager.loadTasks()
                ]);
                // ‡∏ñ‡πâ‡∏≤ tasks ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô array ‡∏ß‡πà‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á empty state
                if (!tasks || tasks.length === 0) {
                    renderDashboard(userInfo, [], null, true);
                    showContent();
                    showToast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô', 'info');
                    return;
                }
                // Render dashboard
                renderDashboard(userInfo, tasks, null);
                showContent();
                showToast('‡πÇ‡∏´‡∏•‡∏î Dashboard ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', 'success');
            } catch (error) {
                console.error('Dashboard loading error:', error);
                showError();
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message, 'error');
            } finally {
                isLoading = false;
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for shared API and DateUtils to be ready
            if (window.apiManager && window.dataManager && window.dateUtils) {
                loadDashboard();
            } else {
                // Fallback if shared API not loaded
                setTimeout(loadDashboard, 100);
            }
        });
    </script>
</body>
</html>
