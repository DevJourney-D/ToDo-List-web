<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - ToDo List App</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÖ</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="common-notifications.js"></script>
    <style>
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .excel-bg {
            background: #f3f4f6;
            min-height: 100vh;
        }
        
        .nav-professional {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .nav-link {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s ease;
            text-decoration: none;
        }
        
        .nav-link:hover {
            background: #f3f4f6;
        }
        
        .nav-link.active {
            background: #3b82f6;
            color: white;
        }
        
        .coming-soon-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .profile-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
            margin: 0 auto 20px;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        
        .achievement-badge {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            border: 2px solid #f59e0b;
        }
        
        .goal-item {
            transition: all 0.3s ease;
        }
        
        .goal-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .icon-option {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .icon-option:hover {
            transform: scale(1.1);
        }
        
        /* Modal Animation */
        .fixed.inset-0 {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Responsive Design for Mobile & Tablet */
        @media (max-width: 1024px) {
            .container {
                padding: 0 16px;
            }
            
            .nav-professional {
                padding: 12px 16px;
            }
            
            .nav-professional .container {
                flex-direction: column;
                gap: 16px;
            }
            
            .nav-professional h1 {
                font-size: 1.5rem;
            }
            
            .nav-professional .flex.items-center.space-x-2 {
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px;
            }
            
            .nav-link {
                padding: 6px 12px;
                font-size: 0.875rem;
            }
            
            .profile-card {
                padding: 16px;
            }
            
            .profile-avatar {
                width: 100px;
                height: 100px;
                font-size: 2.5rem;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 0 12px;
            }
            
            .grid.grid-cols-1.lg\\:grid-cols-3 {
                grid-template-columns: 1fr;
            }
            
            .grid.grid-cols-1.lg\\:grid-cols-2 {
                grid-template-columns: 1fr;
            }
            
            .grid.grid-cols-1.md\\:grid-cols-4 {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .grid.grid-cols-1.md\\:grid-cols-2 {
                grid-template-columns: 1fr;
            }
            
            .profile-card {
                padding: 12px;
            }
            
            .stats-card {
                padding: 16px;
            }
            
            .text-3xl {
                font-size: 1.875rem;
            }
            
            .text-2xl {
                font-size: 1.5rem;
            }
            
            .profile-avatar {
                width: 80px;
                height: 80px;
                font-size: 2rem;
            }
        }
        
        @media (max-width: 480px) {
            .nav-professional .flex.items-center.space-x-2 {
                grid-template-columns: repeat(2, 1fr);
                display: grid;
                gap: 8px;
            }
            
            .nav-link {
                text-align: center;
                padding: 8px 4px;
                font-size: 0.75rem;
            }
            
            .grid.grid-cols-2 {
                gap: 8px;
            }
            
            .grid.grid-cols-1.md\\:grid-cols-4 {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .profile-card {
                padding: 8px;
            }
            
            .form-group {
                margin-bottom: 12px;
            }
            
            .form-input {
                padding: 6px 8px;
                font-size: 14px;
            }
            
            .text-lg {
                font-size: 1rem;
            }
            
            .text-xl {
                font-size: 1.125rem;
            }
            
            .achievement-badge {
                padding: 8px;
            }
        }
        
        /* iPad Air specific adjustments */
        @media (min-width: 820px) and (max-width: 1024px) {
            .grid.grid-cols-1.lg\\:grid-cols-3 {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .lg\\:col-span-2 {
                grid-column: span 2;
            }
            
            .grid.grid-cols-1.md\\:grid-cols-4 {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .grid.grid-cols-1.lg\\:grid-cols-2 {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .nav-professional .flex.items-center.space-x-2 {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .profile-card {
                padding: 20px;
            }
            
            .stats-card {
                padding: 18px;
            }
            
            .grid.grid-cols-1.sm\\:grid-cols-2.lg\\:grid-cols-3 {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-4 {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Responsive modal */
        @media (max-width: 1024px) {
            .modal-content {
                max-width: 90%;
                margin: 20px;
            }
        }
        
        @media (max-width: 768px) {
            .modal-content {
                max-width: 95%;
                margin: 10px;
                padding: 16px;
            }
            
            .grid.grid-cols-7 {
                grid-template-columns: repeat(5, 1fr);
                gap: 8px;
            }
            
            .icon-option {
                padding: 8px;
            }
        }
        
        @media (max-width: 480px) {
            .modal-content {
                max-height: 90vh;
                padding: 12px;
            }
            
            .grid.grid-cols-7 {
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
            }
            
            .grid.grid-cols-2 {
                grid-template-columns: 1fr;
                gap: 12px;
            }
        }
        
        /* Loading Styles */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            padding: 40px 20px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #6b7280;
            font-size: 14px;
        }
        
        /* Edit Mode Styles */
        .edit-mode {
            background: #fef3c7;
            border: 2px solid #f59e0b;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(-50px);
            transition: transform 0.3s ease;
        }
        
        .modal.active .modal-content {
            transform: translateY(0);
        }
        
        /* Button Styles */
        .btn-save {
            background: #10b981;
            color: white;
        }
        
        .btn-save:hover {
            background: #059669;
        }
        
        .btn-cancel {
            background: #6b7280;
            color: white;
        }
        
        .btn-cancel:hover {
            background: #4b5563;
        }
        
        .btn-delete {
            background: #ef4444;
            color: white;
        }
        
        .btn-delete:hover {
            background: #dc2626;
        }
        
        /* Achievement Badge Hover */
        .achievement-badge {
            transition: transform 0.2s ease;
            cursor: pointer;
        }
        
        .achievement-badge:hover {
            transform: scale(1.05);
        }
        
        /* Activity Item Hover */
        .activity-item {
            padding: 12px;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }
        
        .activity-item:hover {
            background: #f9fafb;
        }
        
        /* Stats Animation */
        .stat-number {
            transition: all 0.3s ease;
            font-variant-numeric: tabular-nums;
        }
        
        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            .form-input {
                background: #374151;
                border-color: #4b5563;
                color: #f9fafb;
            }
            
            .modal-content {
                background: #374151;
                color: #f9fafb;
            }
            
            .form-label {
                color: #e5e7eb;
            }
        }
    </style>
</head>
<body class="excel-bg">
    <div id="app" class="min-h-screen">
        <!-- Navigation -->
        <nav class="nav-professional p-4">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-8">
                    <h1 class="text-2xl font-bold text-gray-800">üçÖ ToDo List</h1>
                    <div class="flex items-center space-x-2">
                        <a href="dashboard.html" class="nav-link">üìä Dashboard</a>
                        <a href="tasks.html" class="nav-link">üìã Tasks</a>
                        <a href="calendar.html" class="nav-link">üìÖ Calendar</a>
                        <a href="analytics.html" class="nav-link">üìä Analytics</a>
                        <a href="profile.html" class="nav-link active">üë§ Profile</a>
                        <a href="settings.html" class="nav-link">‚öôÔ∏è Settings</a>
                    </div>
                </div>
                <div id="nav-menu" class="flex items-center space-x-4">
                    <span id="user-greeting" class="text-gray-700 font-medium">Welcome, User</span>
                    <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                        üì§ Logout
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container mx-auto p-6">
            <div class="fade-in">
                <!-- Page Header -->
                <div class="mb-8">
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-800 mb-2">üë§ User Profile</h1>
                            <p class="text-gray-600">Manage your profile information and view your achievements</p>
                        </div>
                        <div id="connection-status" class="flex items-center space-x-2 px-3 py-1 rounded-full text-sm">
                            <div id="status-indicator" class="w-2 h-2 rounded-full"></div>
                            <span id="status-text">Checking...</span>
                        </div>
                    </div>
                </div>

                <!-- Profile Management Section -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <!-- Profile Information Card -->
                    <div class="lg:col-span-2">
                        <div class="profile-card">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl font-bold text-gray-800">üìù Profile Information</h2>
                                <button id="edit-profile-btn" onclick="toggleEditMode()" 
                                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                                    ‚úèÔ∏è Edit Profile
                                </button>
                            </div>
                            
                            <div id="profile-info-section">
                                <div class="loading-container">
                                    <div class="loading-spinner"></div>
                                    <div class="loading-text">Loading profile...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Avatar and Quick Stats -->
                    <div class="space-y-6">
                        <!-- Avatar Section -->
                        <div class="profile-card text-center">
                            <div class="profile-avatar">
                                üë§
                            </div>
                            <div id="user-display-name" class="text-xl font-bold text-gray-800 mb-2">Loading...</div>
                            <div id="user-username" class="text-gray-600 mb-4">@loading</div>
                            <button id="change-avatar-btn" onclick="changeAvatar()" 
                                    class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                                üì∑ Change Avatar
                            </button>
                        </div>

                        <!-- Quick Stats -->
                        <div class="stats-card">
                            <h3 class="text-lg font-bold mb-4">üìä Quick Stats</h3>
                            <div id="quick-stats-section">
                                <div class="loading-container">
                                    <div class="loading-spinner"></div>
                                    <div class="loading-text">Loading stats...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analytics & Activity Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <!-- Recent Activity -->
                    <div class="profile-card">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">üîÑ Recent Activity</h3>
                        <div id="recent-activity-section">
                            <div class="loading-container">
                                <div class="loading-spinner"></div>
                                <div class="loading-text">Loading activity...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Achievements -->
                    <div class="profile-card">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">üèÜ Achievements</h3>
                        <div id="achievements-section">
                            <div class="loading-container">
                                <div class="loading-spinner"></div>
                                <div class="loading-text">Loading achievements...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analytics Dashboard -->
                <div class="profile-card mb-8">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">üìà Performance Analytics</h3>
                    <div id="analytics-section">
                        <div class="loading-container">
                            <div class="loading-spinner"></div>
                            <div class="loading-text">Loading analytics...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE_URL = 'https://to-do-list-api-app.vercel.app/api/v1';
        
        // Check if backend is running
        let isBackendAvailable = false;
        
        // Test backend connection
        async function testBackendConnection() {
            try {
                const response = await fetch('https://to-do-list-api-app.vercel.app/health');
                isBackendAvailable = response.ok;
                return isBackendAvailable;
            } catch (error) {
                isBackendAvailable = false;
                return false;
            }
        }
        
        // Global state
        let token = localStorage.getItem('token');
        let userInfo = null;
        let isEditMode = false;
        let originalUserData = null;
        
        // API Helper Functions
        async function apiRequest(endpoint, method = 'GET', data = null) {
            const config = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            };
            
            if (data) {
                try {
                    // Validate data before JSON.stringify
                    const cleanData = cleanObjectForJSON(data);
                    config.body = JSON.stringify(cleanData);
                    console.log('API Request - Endpoint:', endpoint, 'Method:', method, 'Data:', cleanData);
                } catch (jsonError) {
                    console.error('JSON serialization error:', jsonError);
                    throw new Error('Invalid data format: ' + jsonError.message);
                }
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
                
                if (!response.ok) {
                    if (response.status === 401) {
                        console.log('Unauthorized - redirecting to login');
                        logout();
                        return null;
                    }
                    const errorText = await response.text();
                    console.error('API Error Response:', response.status, errorText);
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }
                
                const result = await response.json();
                console.log('API Response:', result);
                return result;
            } catch (error) {
                console.error('API Request failed:', error);
                throw error;
            }
        }
        
        // Clean object for JSON serialization
        function cleanObjectForJSON(obj) {
            const cleanObj = {};
            
            for (const [key, value] of Object.entries(obj)) {
                // Skip undefined, null, NaN, and empty string values
                if (value !== undefined && value !== null && !Number.isNaN(value) && value !== '') {
                    if (typeof value === 'string') {
                        cleanObj[key] = value.trim();
                    } else if (typeof value === 'number' && isFinite(value)) {
                        cleanObj[key] = value;
                    } else if (typeof value === 'boolean') {
                        cleanObj[key] = value;
                    }
                }
            }
            
            return cleanObj;
        }
        
        // Load User Profile
        async function loadUserProfile() {
            try {
                console.log('Fetching user info from API...');
                
                // Check backend connection first
                const backendConnected = await testBackendConnection();
                updateConnectionStatus(backendConnected);
                
                if (!backendConnected) {
                    console.log('Backend not available, loading basic profile');
                    return loadBasicUserProfile();
                }
                
                const data = await apiRequest('/user/info');
                
                if (data && data.user) {
                    console.log('User info loaded successfully:', data);
                    userInfo = data;
                    originalUserData = JSON.parse(JSON.stringify(data)); // Deep copy
                    
                    // Update UI components
                    displayUserProfile(data);
                    displayQuickStats(data.stats || { total_tasks: 0, completed_tasks: 0, pending_tasks: 0, achieved_habits: 0 });
                    updateUserGreeting(data.user.username);
                    
                    // Save to localStorage for persistence
                    localStorage.setItem('userProfile', JSON.stringify(data));
                    showNotification('Profile loaded from API successfully!', 'success');
                    
                    return true;
                } else {
                    console.error('Invalid user data received:', data);
                    throw new Error('Invalid user data received from server');
                }
            } catch (error) {
                console.error('Failed to load user profile from API:', error);
                showNotification('Failed to connect to API, loading basic profile', 'warning');
                
                // Load basic profile as fallback
                return loadBasicUserProfile();
            }
        }
        
        // Load user profile from stored data or basic info if API fails
        function loadBasicUserProfile() {
            console.log('Loading basic user profile...');
            
            // Try to get user info from localStorage first
            const storedProfile = localStorage.getItem('userProfile');
            if (storedProfile) {
                try {
                    const parsedProfile = JSON.parse(storedProfile);
                    if (parsedProfile.user) {
                        userInfo = parsedProfile;
                        originalUserData = JSON.parse(JSON.stringify(parsedProfile));
                        displayUserProfile(parsedProfile);
                        displayQuickStats(parsedProfile.stats || { total_tasks: 0, completed_tasks: 0, pending_tasks: 0, achieved_habits: 0 });
                        updateUserGreeting(parsedProfile.user.username);
                        showNotification('Profile loaded from local storage', 'info');
                        return true;
                    }
                } catch (error) {
                    console.error('Error parsing stored profile:', error);
                }
            }
            
            // Fallback to basic user info from token or localStorage
            const username = localStorage.getItem('username') || 'User';
            const userId = localStorage.getItem('userId') || 1;
            
            const basicData = {
                user: {
                    id: userId,
                    username: username,
                    display_name: username,
                    email: "",
                    location: "",
                    bio: "",
                    created_at: new Date().toISOString()
                },
                stats: {
                    total_tasks: 0,
                    completed_tasks: 0,
                    pending_tasks: 0,
                    achieved_habits: 0
                }
            };
            
            userInfo = basicData;
            originalUserData = JSON.parse(JSON.stringify(basicData));
            
            displayUserProfile(basicData);
            displayQuickStats(basicData.stats);
            updateUserGreeting(basicData.user.username);
            
            localStorage.setItem('userProfile', JSON.stringify(basicData));
            showNotification('Basic profile loaded - please update your information', 'info');
            
            return true;
        }
        
        // Display User Profile
        function displayUserProfile(data) {
            const profileSection = document.getElementById('profile-info-section');
            const displayName = document.getElementById('user-display-name');
            const username = document.getElementById('user-username');
            
            // Update avatar section
            displayName.textContent = data.user.username;
            username.textContent = `@${data.user.username}`;
            
            // Create profile form (both view and edit mode)
            profileSection.innerHTML = createProfileForm(data.user, false);
        }
        
        // Show loading state for a specific section
        function showSectionLoading(sectionId, message = 'Loading...') {
            const section = document.getElementById(sectionId);
            if (section) {
                section.innerHTML = `
                    <div class="loading-container" style="min-height: 200px;">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">${message}</div>
                    </div>
                `;
            }
        }
        
        // Show error state for a specific section
        function showSectionError(sectionId, message = 'Failed to load', retryFunction = null) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">‚ö†Ô∏è</div>
                        <p>${message}</p>
                        ${retryFunction ? `
                            <button onclick="${retryFunction}()" class="mt-2 text-blue-500 hover:text-blue-700">
                                Try Again
                            </button>
                        ` : ''}
                    </div>
                `;
            }
        }
        
        // Create Profile Form
        function createProfileForm(user, editMode = false) {
            const memberSince = new Date(user.created_at).toLocaleDateString();
            
            return `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        ${editMode ? 
                            `<input type="text" id="edit-username" class="form-input" value="${user.username}" readonly 
                                   title="Username cannot be changed">` :
                            `<div class="p-3 bg-gray-50 rounded-lg">${user.username}</div>`
                        }
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">User ID</label>
                        <div class="p-3 bg-gray-50 rounded-lg">#${user.id}</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Display Name</label>
                        ${editMode ? 
                            `<input type="text" id="edit-display-name" class="form-input" 
                                   value="${escapeHtml(user.display_name || user.username)}" 
                                   placeholder="Your display name" maxlength="100">` :
                            `<div class="p-3 bg-gray-50 rounded-lg">${escapeHtml(user.display_name || user.username)}</div>`
                        }
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        ${editMode ? 
                            `<input type="email" id="edit-email" class="form-input" 
                                   value="${escapeHtml(user.email || '')}" 
                                   placeholder="your.email@example.com" maxlength="255">` :
                            `<div class="p-3 bg-gray-50 rounded-lg">${escapeHtml(user.email || 'Not provided')}</div>`
                        }
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Location (‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î)</label>
                        ${editMode ? 
                            `<select id="edit-location" class="form-input">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</option>
                                <option value="‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£" ${user.location === '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£' ? 'selected' : ''}>‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£</option>
                                <option value="‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà" ${user.location === '‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà' ? 'selected' : ''}>‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà</option>
                                <option value="‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ" ${user.location === '‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ' ? 'selected' : ''}>‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ</option>
                                <option value="‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå" ${user.location === '‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå' ? 'selected' : ''}>‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå</option>
                                <option value="‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£" ${user.location === '‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£' ? 'selected' : ''}>‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£</option>
                                <option value="‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô" ${user.location === '‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô' ? 'selected' : ''}>‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô</option>
                                <option value="‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ" ${user.location === '‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ' ? 'selected' : ''}>‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ</option>
                                <option value="‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤" ${user.location === '‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤' ? 'selected' : ''}>‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤</option>
                                <option value="‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ" ${user.location === '‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ' ? 'selected' : ''}>‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ</option>
                                <option value="‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó" ${user.location === '‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó' ? 'selected' : ''}>‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó</option>
                                <option value="‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥" ${user.location === '‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥' ? 'selected' : ''}>‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥</option>
                                <option value="‡∏ä‡∏∏‡∏°‡∏û‡∏£" ${user.location === '‡∏ä‡∏∏‡∏°‡∏û‡∏£' ? 'selected' : ''}>‡∏ä‡∏∏‡∏°‡∏û‡∏£</option>
                                <option value="‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢" ${user.location === '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢' ? 'selected' : ''}>‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢</option>
                                <option value="‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà" ${user.location === '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà' ? 'selected' : ''}>‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà</option>
                                <option value="‡∏ï‡∏£‡∏±‡∏á" ${user.location === '‡∏ï‡∏£‡∏±‡∏á' ? 'selected' : ''}>‡∏ï‡∏£‡∏±‡∏á</option>
                                <option value="‡∏ï‡∏£‡∏≤‡∏î" ${user.location === '‡∏ï‡∏£‡∏≤‡∏î' ? 'selected' : ''}>‡∏ï‡∏£‡∏≤‡∏î</option>
                                <option value="‡∏ï‡∏≤‡∏Å" ${user.location === '‡∏ï‡∏≤‡∏Å' ? 'selected' : ''}>‡∏ï‡∏≤‡∏Å</option>
                                <option value="‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å" ${user.location === '‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å' ? 'selected' : ''}>‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å</option>
                                <option value="‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°" ${user.location === '‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°' ? 'selected' : ''}>‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°</option>
                                <option value="‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°" ${user.location === '‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°' ? 'selected' : ''}>‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°</option>
                                <option value="‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤" ${user.location === '‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤' ? 'selected' : ''}>‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤</option>
                                <option value="‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä" ${user.location === '‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä' ? 'selected' : ''}>‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä</option>
                                <option value="‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå" ${user.location === '‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå' ? 'selected' : ''}>‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå</option>
                                <option value="‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ" ${user.location === '‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ' ? 'selected' : ''}>‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ</option>
                                <option value="‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™" ${user.location === '‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™' ? 'selected' : ''}>‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™</option>
                                <option value="‡∏ô‡πà‡∏≤‡∏ô" ${user.location === '‡∏ô‡πà‡∏≤‡∏ô' ? 'selected' : ''}>‡∏ô‡πà‡∏≤‡∏ô</option>
                                <option value="‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨" ${user.location === '‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨' ? 'selected' : ''}>‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨</option>
                                <option value="‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå" ${user.location === '‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå' ? 'selected' : ''}>‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå</option>
                                <option value="‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ" ${user.location === '‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ' ? 'selected' : ''}>‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ</option>
                                <option value="‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå" ${user.location === '‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå' ? 'selected' : ''}>‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå</option>
                                <option value="‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ" ${user.location === '‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ' ? 'selected' : ''}>‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ</option>
                                <option value="‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ" ${user.location === '‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ' ? 'selected' : ''}>‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ</option>
                                <option value="‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤" ${user.location === '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤' ? 'selected' : ''}>‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤</option>
                                <option value="‡∏û‡∏±‡∏á‡∏á‡∏≤" ${user.location === '‡∏û‡∏±‡∏á‡∏á‡∏≤' ? 'selected' : ''}>‡∏û‡∏±‡∏á‡∏á‡∏≤</option>
                                <option value="‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á" ${user.location === '‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á' ? 'selected' : ''}>‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á</option>
                                <option value="‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£" ${user.location === '‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£' ? 'selected' : ''}>‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£</option>
                                <option value="‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å" ${user.location === '‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å' ? 'selected' : ''}>‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å</option>
                                <option value="‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ" ${user.location === '‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ' ? 'selected' : ''}>‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ</option>
                                <option value="‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå" ${user.location === '‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå' ? 'selected' : ''}>‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå</option>
                                <option value="‡πÅ‡∏û‡∏£‡πà" ${user.location === '‡πÅ‡∏û‡∏£‡πà' ? 'selected' : ''}>‡πÅ‡∏û‡∏£‡πà</option>
                                <option value="‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï" ${user.location === '‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï' ? 'selected' : ''}>‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï</option>
                                <option value="‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°" ${user.location === '‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°' ? 'selected' : ''}>‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°</option>
                                <option value="‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£" ${user.location === '‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£' ? 'selected' : ''}>‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£</option>
                                <option value="‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô" ${user.location === '‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô' ? 'selected' : ''}>‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô</option>
                                <option value="‡∏¢‡∏∞‡∏•‡∏≤" ${user.location === '‡∏¢‡∏∞‡∏•‡∏≤' ? 'selected' : ''}>‡∏¢‡∏∞‡∏•‡∏≤</option>
                                <option value="‡∏¢‡πÇ‡∏ã‡∏ò‡∏£" ${user.location === '‡∏¢‡πÇ‡∏ã‡∏ò‡∏£' ? 'selected' : ''}>‡∏¢‡πÇ‡∏ã‡∏ò‡∏£</option>
                                <option value="‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î" ${user.location === '‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î' ? 'selected' : ''}>‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î</option>
                                <option value="‡∏£‡∏∞‡∏ô‡∏≠‡∏á" ${user.location === '‡∏£‡∏∞‡∏ô‡∏≠‡∏á' ? 'selected' : ''}>‡∏£‡∏∞‡∏ô‡∏≠‡∏á</option>
                                <option value="‡∏£‡∏∞‡∏¢‡∏≠‡∏á" ${user.location === '‡∏£‡∏∞‡∏¢‡∏≠‡∏á' ? 'selected' : ''}>‡∏£‡∏∞‡∏¢‡∏≠‡∏á</option>
                                <option value="‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ" ${user.location === '‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ' ? 'selected' : ''}>‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ</option>
                                <option value="‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ" ${user.location === '‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ' ? 'selected' : ''}>‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ</option>
                                <option value="‡∏•‡∏≥‡∏õ‡∏≤‡∏á" ${user.location === '‡∏•‡∏≥‡∏õ‡∏≤‡∏á' ? 'selected' : ''}>‡∏•‡∏≥‡∏õ‡∏≤‡∏á</option>
                                <option value="‡∏•‡∏≥‡∏û‡∏π‡∏ô" ${user.location === '‡∏•‡∏≥‡∏û‡∏π‡∏ô' ? 'selected' : ''}>‡∏•‡∏≥‡∏û‡∏π‡∏ô</option>
                                <option value="‡πÄ‡∏•‡∏¢" ${user.location === '‡πÄ‡∏•‡∏¢' ? 'selected' : ''}>‡πÄ‡∏•‡∏¢</option>
                                <option value="‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©" ${user.location === '‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©' ? 'selected' : ''}>‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©</option>
                                <option value="‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£" ${user.location === '‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£' ? 'selected' : ''}>‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£</option>
                                <option value="‡∏™‡∏á‡∏Ç‡∏•‡∏≤" ${user.location === '‡∏™‡∏á‡∏Ç‡∏•‡∏≤' ? 'selected' : ''}>‡∏™‡∏á‡∏Ç‡∏•‡∏≤</option>
                                <option value="‡∏™‡∏ï‡∏π‡∏•" ${user.location === '‡∏™‡∏ï‡∏π‡∏•' ? 'selected' : ''}>‡∏™‡∏ï‡∏π‡∏•</option>
                                <option value="‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£" ${user.location === '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£' ? 'selected' : ''}>‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£</option>
                                <option value="‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°" ${user.location === '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°' ? 'selected' : ''}>‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°</option>
                                <option value="‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£" ${user.location === '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£' ? 'selected' : ''}>‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£</option>
                                <option value="‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß" ${user.location === '‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß' ? 'selected' : ''}>‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß</option>
                                <option value="‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ" ${user.location === '‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ' ? 'selected' : ''}>‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ</option>
                                <option value="‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ" ${user.location === '‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ' ? 'selected' : ''}>‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ</option>
                                <option value="‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢" ${user.location === '‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢' ? 'selected' : ''}>‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢</option>
                                <option value="‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ" ${user.location === '‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ' ? 'selected' : ''}>‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ</option>
                                <option value="‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ" ${user.location === '‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ' ? 'selected' : ''}>‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ</option>
                                <option value="‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå" ${user.location === '‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå' ? 'selected' : ''}>‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå</option>
                                <option value="‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢" ${user.location === '‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢' ? 'selected' : ''}>‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢</option>
                                <option value="‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π" ${user.location === '‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π' ? 'selected' : ''}>‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π</option>
                                <option value="‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á" ${user.location === '‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á' ? 'selected' : ''}>‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á</option>
                                <option value="‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç" ${user.location === '‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç' ? 'selected' : ''}>‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç</option>
                                <option value="‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ" ${user.location === '‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ' ? 'selected' : ''}>‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ</option>
                                <option value="‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå" ${user.location === '‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå' ? 'selected' : ''}>‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå</option>
                                <option value="‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ" ${user.location === '‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ' ? 'selected' : ''}>‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ</option>
                                <option value="‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ" ${user.location === '‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ' ? 'selected' : ''}>‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ</option>
                            </select>` :
                            `<div class="p-3 bg-gray-50 rounded-lg">${user.location || 'Not provided'}</div>`
                        }
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Member Since</label>
                        <div class="p-3 bg-gray-50 rounded-lg">${memberSince}</div>
                    </div>
                    
                    <div class="form-group md:col-span-2">
                        <label class="form-label">Bio</label>
                        ${editMode ? 
                            `<textarea id="edit-bio" class="form-input form-textarea" 
                                      placeholder="Tell us about yourself..." maxlength="500">${escapeHtml(user.bio || '')}</textarea>` :
                            `<div class="p-3 bg-gray-50 rounded-lg min-h-[80px]">${escapeHtml(user.bio || 'No bio provided')}</div>`
                        }
                    </div>
                    
                    ${editMode ? `
                    <div class="form-group md:col-span-2">
                        <div class="border-t pt-4 mt-4">
                            <h4 class="text-lg font-medium text-gray-800 mb-4">üîí Change Password</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="form-group">
                                    <label class="form-label">Current Password</label>
                                    <input type="password" id="edit-current-password" class="form-input" 
                                           placeholder="Enter current password">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">New Password</label>
                                    <input type="password" id="edit-new-password" class="form-input" 
                                           placeholder="Enter new password (min 6 characters)">
                                </div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>
                
                ${editMode ? `
                    <div class="flex gap-4 mt-6">
                        <button onclick="saveProfile()" class="btn-save px-6 py-2 rounded-lg font-medium transition-colors">
                            üíæ Save Changes
                        </button>
                        <button onclick="cancelEdit()" class="btn-cancel px-6 py-2 rounded-lg font-medium transition-colors">
                            ‚úñÔ∏è Cancel
                        </button>
                    </div>
                ` : ''}
            `;
        }
        
        // Change Password Function
        async function changePassword(currentPassword, newPassword) {
            if (!currentPassword || !newPassword) {
                showNotification('Please fill in both current and new password', 'warning');
                return false;
            }
            
            if (newPassword.length < 6) {
                showNotification('New password must be at least 6 characters long', 'warning');
                return false;
            }
            
            const passwordData = {
                current_password: currentPassword,
                new_password: newPassword
            };
            
            try {
                console.log('Changing password...');
                
                // Check if backend is available
                const backendConnected = await testBackendConnection();
                
                if (backendConnected) {
                    // Try real API call
                    const result = await apiRequest('/user/change-password', 'PATCH', passwordData);
                    
                    if (result) {
                        showNotification('Password changed successfully!', 'success');
                        return true;
                    } else {
                        throw new Error('Failed to change password');
                    }
                } else {
                    // Demo mode - simulate password change
                    showNotification('Demo mode: Password change simulated locally!', 'info');
                    return true;
                }
                
            } catch (error) {
                console.error('Failed to change password:', error);
                
                if (error.message.includes('invalid current password') || error.message.includes('Current password is incorrect')) {
                    showNotification('Current password is incorrect', 'error');
                } else {
                    showNotification('Failed to change password: ' + error.message, 'error');
                }
                return false;
            }
        }
        
        // Helper function to escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Display Quick Stats
        function displayQuickStats(stats) {
            const statsSection = document.getElementById('quick-stats-section');
            const completionRate = stats.total_tasks > 0 ? 
                Math.round((stats.completed_tasks / stats.total_tasks) * 100) : 0;
            
            statsSection.innerHTML = `
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div>
                        <div class="text-2xl font-bold stat-number">${stats.total_tasks}</div>
                        <div class="text-sm opacity-90">Total Tasks</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold stat-number">${completionRate}%</div>
                        <div class="text-sm opacity-90">Completion Rate</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold stat-number">${stats.pending_tasks}</div>
                        <div class="text-sm opacity-90">Pending</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold stat-number">${stats.achieved_habits}</div>
                        <div class="text-sm opacity-90">Habits Done</div>
                    </div>
                </div>
            `;
        }
        
        // Load Recent Activity
        async function loadRecentActivity() {
            try {
                console.log('Fetching recent activity...');
                
                // Check backend connection
                const backendConnected = await testBackendConnection();
                
                if (backendConnected) {
                    try {
                        const data = await apiRequest('/user/logs?limit=10');
                        
                        if (data && data.logs && Array.isArray(data.logs)) {
                            console.log('Recent activity loaded:', data.logs.length, 'items');
                            displayRecentActivity(data.logs);
                            showNotification('Activity loaded from API successfully!', 'success');
                            return true;
                        } else {
                            console.log('No activity data received, showing empty state');
                            displayRecentActivity([]);
                            return true;
                        }
                    } catch (error) {
                        console.warn('API call failed:', error);
                        showNotification('API not available, showing no activity', 'warning');
                    }
                } else {
                    console.log('Backend not available');
                    showNotification('Backend offline, showing no activity', 'info');
                }
                
                // Show empty state when no real data
                displayRecentActivity([]);
                return true;
                
            } catch (error) {
                console.error('Failed to load recent activity:', error);
                showNotification('Failed to load recent activity', 'error');
                
                // Show error state
                const activitySection = document.getElementById('recent-activity-section');
                activitySection.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">‚ö†Ô∏è</div>
                        <p>Failed to load activity</p>
                        <button onclick="loadRecentActivity()" class="mt-2 text-blue-500 hover:text-blue-700">
                            Try Again
                        </button>
                    </div>
                `;
                return false;
            }
        }
        
        // Display Recent Activity
        function displayRecentActivity(logs) {
            const activitySection = document.getElementById('recent-activity-section');
            
            if (!logs || logs.length === 0) {
                activitySection.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">üì≠</div>
                        <p>No recent activity</p>
                    </div>
                `;
                return;
            }
            
            const activitiesHtml = logs.slice(0, 5).map(log => {
                const timeAgo = getTimeAgo(new Date(log.created_at));
                const icon = getActivityIcon(log.event_type);
                
                return `
                    <div class="activity-item flex items-center space-x-3">
                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-sm">
                            ${icon}
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-medium">${log.description}</p>
                            <p class="text-xs text-gray-500">${timeAgo}</p>
                        </div>
                    </div>
                `;
            }).join('');
            
            activitySection.innerHTML = activitiesHtml;
        }
        
        // Load Analytics from Real API with Enhanced Metrics
        async function loadAnalytics() {
            try {
                console.log('Fetching analytics data...');
                
                // Always try to load from real API first
                const backendConnected = await testBackendConnection();
                
                if (backendConnected) {
                    let taskAnalytics = null;
                    let habitAnalytics = null;
                    let weeklyPerformance = null;
                    
                    try {
                        // Load analytics data one by one to avoid overwhelming the API
                        console.log('Loading real API data...');
                        
                        taskAnalytics = await apiRequest('/analytics/tasks');
                        console.log('Task analytics loaded:', taskAnalytics);
                        
                        habitAnalytics = await apiRequest('/analytics/habits');
                        console.log('Habit analytics loaded:', habitAnalytics);
                        
                        weeklyPerformance = await apiRequest('/analytics/performance/weekly');
                        console.log('Weekly performance loaded:', weeklyPerformance);
                        
                        // Use real data if available
                        if (taskAnalytics || habitAnalytics || weeklyPerformance) {
                            displayEnhancedAnalytics(taskAnalytics, habitAnalytics, weeklyPerformance, null);
                            showNotification('Analytics loaded from API successfully!', 'success');
                            return true;
                        }
                        
                    } catch (error) {
                        console.warn('API calls failed, showing basic analytics:', error);
                        showNotification('API analytics not available', 'warning');
                    }
                } else {
                    console.log('Backend not available, showing basic analytics');
                    showNotification('Backend offline, showing basic analytics', 'info');
                }
                
                // Fallback: Basic analytics with real user data if available
                const taskAnalytics = {
                    completion_rate: userInfo?.stats ? Math.round((userInfo.stats.completed_tasks / (userInfo.stats.total_tasks || 1)) * 100) : 0,
                    total_tasks: userInfo?.stats?.total_tasks || 0,
                    completed_tasks: userInfo?.stats?.completed_tasks || 0,
                    pending_tasks: userInfo?.stats?.pending_tasks || 0,
                    overdue_tasks: 0,
                    average_completion_time: 0,
                    productivity_trend: [65, 72, 78, 81, 76, 78, 85]
                };
                
                const habitAnalytics = {
                    achievement_rate: userInfo?.stats?.achieved_habits || 0,
                    total_habits: Math.max(userInfo?.stats?.achieved_habits || 0, 3),
                    active_streaks: 1,
                    longest_streak: 7,
                    weekly_consistency: 75,
                    habit_categories: {
                        'Health': 80,
                        'Work': 70,
                        'Learning': 65
                    }
                };
                
                const weeklyPerformance = {
                    productivity_score: taskAnalytics.completion_rate || 0,
                    focus_time: Math.floor((taskAnalytics.completed_tasks || 0) * 0.5),
                    pomodoro_sessions: Math.floor((taskAnalytics.completed_tasks || 0) * 1.2),
                    efficiency_rating: taskAnalytics.completion_rate > 80 ? 'High' : taskAnalytics.completion_rate > 50 ? 'Medium' : 'Low',
                    improvement: 0,
                    weekly_goals_met: Math.min(taskAnalytics.completed_tasks || 0, 5),
                    weekly_goals_total: 5
                };
                
                const goalsProgress = {
                    monthly_target: {
                        title: "‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô",
                        completed: taskAnalytics.completed_tasks || 0,
                        target: 30,
                        percentage: Math.min(((taskAnalytics.completed_tasks || 0) / 30) * 100, 100)
                    },
                    yearly_target: {
                        title: "‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ",
                        completed: taskAnalytics.completed_tasks || 0,
                        target: 365,
                        percentage: Math.min(((taskAnalytics.completed_tasks || 0) / 365) * 100, 100)
                    }
                };
                
                displayEnhancedAnalytics(taskAnalytics, habitAnalytics, weeklyPerformance, goalsProgress);
                return true;
                
            } catch (error) {
                console.error('Failed to load analytics:', error);
                showNotification('Failed to load analytics data', 'error');
                
                // Show error state
                const analyticsSection = document.getElementById('analytics-section');
                analyticsSection.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">üìä</div>
                        <p>Analytics temporarily unavailable</p>
                        <button onclick="retryLoadAnalytics()" class="mt-2 text-blue-500 hover:text-blue-700">
                            Retry Loading
                        </button>
                    </div>
                `;
                return false;
            }
        }
        
        // Display Enhanced Analytics with Goals and Targets
        function displayEnhancedAnalytics(taskData, habitData, performanceData, goalsData) {
            const analyticsSection = document.getElementById('analytics-section');
            
            const getTrendIcon = (value) => value > 0 ? 'üìà' : value < 0 ? 'üìâ' : '‚û°Ô∏è';
            const getTrendColor = (value) => value > 0 ? 'text-green-600' : value < 0 ? 'text-red-600' : 'text-gray-600';
            
            analyticsSection.innerHTML = `
                <!-- Top Level KPIs -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="text-center p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg border border-blue-200">
                        <h4 class="font-medium text-gray-700 mb-2">üìã ‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h4>
                        <div class="text-2xl font-bold text-blue-600">${taskData?.completion_rate?.toFixed(1) || 0}%</div>
                        <div class="text-sm text-gray-600">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
                        <div class="text-xs ${getTrendColor(taskData?.improvement || 0)} mt-1">
                            ${getTrendIcon(taskData?.improvement || 0)} ${Math.abs(taskData?.improvement || 0)}% ‡∏à‡∏≤‡∏Å‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß
                        </div>
                    </div>
                    
                    <div class="text-center p-4 bg-gradient-to-br from-green-50 to-green-100 rounded-lg border border-green-200">
                        <h4 class="font-medium text-gray-700 mb-2">üèÉ‚Äç‚ôÇÔ∏è ‡∏ô‡∏¥‡∏™‡∏±‡∏¢‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</h4>
                        <div class="text-2xl font-bold text-green-600">${habitData?.achievement_rate?.toFixed(1) || 0}%</div>
                        <div class="text-sm text-gray-600">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
                        <div class="text-xs text-green-600 mt-1">
                            üî• Streak: ${habitData?.longest_streak || 0} ‡∏ß‡∏±‡∏ô
                        </div>
                    </div>
                    
                    <div class="text-center p-4 bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg border border-purple-200">
                        <h4 class="font-medium text-gray-700 mb-2">‚ö° ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û</h4>
                        <div class="text-2xl font-bold text-purple-600">${performanceData?.productivity_score?.toFixed(1) || 0}</div>
                        <div class="text-sm text-gray-600">${performanceData?.efficiency_rating || 'Medium'}</div>
                        <div class="text-xs ${getTrendColor(performanceData?.improvement || 0)} mt-1">
                            ${getTrendIcon(performanceData?.improvement || 0)} ${Math.abs(performanceData?.improvement || 0)}% ‡∏à‡∏≤‡∏Å‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß
                        </div>
                    </div>
                    
                    <div class="text-center p-4 bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-lg border border-yellow-200">
                        <h4 class="font-medium text-gray-700 mb-2">üéØ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</h4>
                        <div class="text-2xl font-bold text-yellow-600">${performanceData?.weekly_goals_met || 0}/${performanceData?.weekly_goals_total || 5}</div>
                        <div class="text-sm text-gray-600">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏£‡∏•‡∏∏</div>
                        <div class="w-full bg-yellow-200 rounded-full h-2 mt-2">
                            <div class="bg-yellow-500 h-2 rounded-full transition-all duration-300" 
                                 style="width: ${((performanceData?.weekly_goals_met || 0) / (performanceData?.weekly_goals_total || 5)) * 100}%"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Detailed Metrics -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Task Analytics -->
                    <div class="bg-white p-6 rounded-lg border border-gray-200">
                        <h4 class="font-bold text-gray-800 mb-4 flex items-center">
                            üìä <span class="ml-2">‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏á‡∏≤‡∏ô</span>
                        </h4>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
                                <span class="font-semibold">${taskData?.total_tasks || 0} ‡∏á‡∏≤‡∏ô</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à:</span>
                                <span class="font-semibold text-green-600">${taskData?.completed_tasks || 0} ‡∏á‡∏≤‡∏ô</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á:</span>
                                <span class="font-semibold text-yellow-600">${taskData?.pending_tasks || 0} ‡∏á‡∏≤‡∏ô</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î:</span>
                                <span class="font-semibold text-red-600">${taskData?.overdue_tasks || 0} ‡∏á‡∏≤‡∏ô</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏á‡∏≤‡∏ô:</span>
                                <span class="font-semibold">${taskData?.average_completion_time || 0} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Goals Progress -->
                    <div class="bg-white p-6 rounded-lg border border-gray-200">
                        <h4 class="font-bold text-gray-800 mb-4 flex items-center">
                            üéØ <span class="ml-2">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</span>
                        </h4>
                        <div class="space-y-4">
                            ${goalsData?.monthly_target ? `
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-medium text-gray-700">${goalsData.monthly_target.title}</span>
                                        <span class="text-sm text-gray-600">${goalsData.monthly_target.completed}/${goalsData.monthly_target.target}</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-blue-500 h-2 rounded-full transition-all duration-300" 
                                             style="width: ${goalsData.monthly_target.percentage}%"></div>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">${goalsData.monthly_target.percentage.toFixed(1)}% ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
                                </div>
                            ` : ''}
                            
                            ${goalsData?.yearly_target ? `
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-medium text-gray-700">${goalsData.yearly_target.title}</span>
                                        <span class="text-sm text-gray-600">${goalsData.yearly_target.completed}/${goalsData.yearly_target.target}</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-green-500 h-2 rounded-full transition-all duration-300" 
                                             style="width: ${goalsData.yearly_target.percentage}%"></div>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">${goalsData.yearly_target.percentage.toFixed(1)}% ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
                                </div>
                            ` : ''}
                            
                            <!-- Pomodoro Stats -->
                            <div class="pt-3 border-t border-gray-200">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">üçÖ Pomodoro ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ:</span>
                                    <span class="font-semibold">${performanceData?.pomodoro_sessions || 0} ‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡πà‡∏ô</span>
                                </div>
                                <div class="flex justify-between mt-1">
                                    <span class="text-gray-600">‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏ü‡∏Å‡∏±‡∏™:</span>
                                    <span class="font-semibold">${performanceData?.focus_time || 0} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Items -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg border border-blue-200">
                    <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                        üí° <span class="ml-2">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á</span>
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-white p-4 rounded-lg">
                            <div class="font-medium text-gray-700 mb-2">üìà ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û</div>
                            <div class="text-sm text-gray-600">
                                ‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ Pomodoro ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÇ‡∏ü‡∏Å‡∏±‡∏™
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-lg">
                            <div class="font-medium text-gray-700 mb-2">üéØ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</div>
                            <div class="text-sm text-gray-600">
                                ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Load Achievements from Real API
        async function loadAchievements() {
            try {
                const achievementsSection = document.getElementById('achievements-section');
                showSectionLoading('achievements-section', 'Loading achievements...');
                
                // Always try to load from real API first
                const backendConnected = await testBackendConnection();
                
                if (backendConnected) {
                    try {
                        // Load real data from API
                        const habitAnalytics = await apiRequest('/analytics/habits');
                        const taskAnalytics = await apiRequest('/analytics/tasks');
                        
                        if (habitAnalytics || taskAnalytics) {
                            // Create achievements from real data
                            const achievements = createAchievementsFromAnalytics(habitAnalytics, taskAnalytics);
                            displayAchievements(achievements, []);
                            console.log('Achievements created from real analytics data');
                            return;
                        }
                    } catch (error) {
                        console.warn('API call failed, using basic achievements:', error);
                    }
                } else {
                    console.log('Backend not available, using basic achievements');
                }
                
                // Fallback: Basic achievements based on user stats
                const stats = userInfo?.stats || { total_tasks: 0, completed_tasks: 0, pending_tasks: 0, achieved_habits: 0 };
                
                const achievements = [
                    { 
                        icon: 'üèÜ', 
                        title: 'Getting Started', 
                        description: `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏£‡∏Å‡πÅ‡∏•‡πâ‡∏ß`, 
                        earned: stats.total_tasks > 0,
                        progress: Math.min(stats.total_tasks, 1),
                        target: 1,
                        type: 'first_task'
                    },
                    { 
                        icon: '‚úÖ', 
                        title: 'Task Completer', 
                        description: '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß 5 ‡∏á‡∏≤‡∏ô', 
                        earned: stats.completed_tasks >= 5,
                        progress: Math.min(stats.completed_tasks, 5),
                        target: 5,
                        type: 'completed_tasks'
                    },
                    { 
                        icon: 'üìà', 
                        title: 'Productive User', 
                        description: '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß 10+ ‡∏á‡∏≤‡∏ô', 
                        earned: stats.completed_tasks >= 10,
                        progress: Math.min(stats.completed_tasks, 10),
                        target: 10,
                        type: 'productivity'
                    },
                    { 
                        icon: 'üéØ', 
                        title: 'Goal Achiever', 
                        description: '‡∏ö‡∏£‡∏£‡∏•‡∏∏‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ 20 ‡∏á‡∏≤‡∏ô', 
                        earned: stats.completed_tasks >= 20,
                        progress: Math.min(stats.completed_tasks, 20),
                        target: 20,
                        type: 'goal_achievement'
                    },
                    { 
                        icon: 'üî•', 
                        title: 'Habit Tracker', 
                        description: '‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ô‡∏¥‡∏™‡∏±‡∏¢‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß', 
                        earned: stats.achieved_habits > 0,
                        progress: Math.min(stats.achieved_habits, 1),
                        target: 1,
                        type: 'habit_tracking'
                    },
                    { 
                        icon: '‚ö°', 
                        title: 'Super User', 
                        description: '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß 50+ ‡∏á‡∏≤‡∏ô', 
                        earned: stats.completed_tasks >= 50,
                        progress: Math.min(stats.completed_tasks, 50),
                        target: 50,
                        type: 'super_user'
                    }
                ];
                
                // Also create basic goals
                const goals = [
                    {
                        icon: 'üìä',
                        title: '‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ',
                        description: '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à 5 ‡∏á‡∏≤‡∏ô',
                        progress: Math.min(stats.completed_tasks, 5),
                        target: 5,
                        deadline: '‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå',
                        type: 'weekly_target'
                    },
                    {
                        icon: 'üéØ',
                        title: '‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ',
                        description: '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à 15 ‡∏á‡∏≤‡∏ô',
                        progress: Math.min(stats.completed_tasks, 15),
                        target: 15,
                        deadline: '‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
                        type: 'monthly_target'
                    }
                ];
                
                displayAchievements(achievements, goals);
                
            } catch (error) {
                console.error('Failed to load achievements:', error);
                showSectionError('achievements-section', 'Failed to load achievements', 'loadAchievements');
            }
        }
        
        // Goals Management System
        let userGoals = JSON.parse(localStorage.getItem('userGoals') || '[]');
        let editingGoalIndex = -1;

        // Display Achievements and Goals with CRUD functionality
        function displayAchievements(achievements, goals = []) {
            const achievementsSection = document.getElementById('achievements-section');
            
            // Merge with user goals
            const allGoals = [...goals, ...userGoals];
            
            const achievementsHtml = achievements.map(achievement => {
                const progressPercent = achievement.target ? Math.round((achievement.progress / achievement.target) * 100) : 0;
                const isNearCompletion = progressPercent >= 80 && !achievement.earned;
                
                return `
                    <div class="achievement-badge ${achievement.earned ? 'border-green-500 bg-green-50' : isNearCompletion ? 'border-yellow-500 bg-yellow-50' : 'opacity-70 border-gray-300'} mb-3 relative">
                        <div class="text-2xl mb-1">${achievement.icon}</div>
                        <div class="text-sm font-bold text-gray-800">${achievement.title}</div>
                        <div class="text-xs text-gray-600 mb-2">${achievement.description}</div>
                        
                        ${achievement.target ? `
                            <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                                <div class="bg-blue-500 h-2 rounded-full transition-all duration-300" 
                                     style="width: ${Math.min(progressPercent, 100)}%"></div>
                            </div>
                            <div class="text-xs text-gray-500">${achievement.progress}/${achievement.target}</div>
                        ` : ''}
                        
                        ${achievement.earned ? 
                            '<div class="absolute top-2 right-2 text-green-600">‚úÖ</div>' : 
                            isNearCompletion ? '<div class="absolute top-2 right-2 text-yellow-600">‚è≥</div>' :
                            '<div class="absolute top-2 right-2 text-gray-400">üîí</div>'
                        }
                    </div>
                `;
            }).join('');
            
            const goalsHtml = allGoals.map((goal, index) => {
                const progressPercent = Math.round((goal.progress / goal.target) * 100);
                const statusColor = progressPercent >= 100 ? 'green' : progressPercent >= 70 ? 'yellow' : 'blue';
                const isUserGoal = index >= goals.length; // User-created goals come after predefined ones
                
                return `
                    <div class="goal-item border border-${statusColor}-300 bg-${statusColor}-50 rounded-lg p-4 mb-3 relative">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center flex-1">
                                <div class="text-xl mr-2">${goal.icon}</div>
                                <div class="flex-1">
                                    <div class="text-sm font-bold text-gray-800">${goal.title}</div>
                                    <div class="text-xs text-gray-600">${goal.description}</div>
                                </div>
                            </div>
                            ${isUserGoal ? `
                                <div class="flex gap-1 ml-2">
                                    <button onclick="editGoal(${index - goals.length})" class="text-blue-500 hover:text-blue-700 text-xs p-1 rounded" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                                        ‚úèÔ∏è
                                    </button>
                                    <button onclick="deleteGoal(${index - goals.length})" class="text-red-500 hover:text-red-700 text-xs p-1 rounded" title="‡∏•‡∏ö">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="mb-2">
                            <div class="text-xs text-gray-500 mb-1">${goal.progress}/${goal.target} (${progressPercent}%)</div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-${statusColor}-500 h-2 rounded-full transition-all duration-300" 
                                     style="width: ${Math.min(progressPercent, 100)}%"></div>
                            </div>
                        </div>
                        
                        ${goal.deadline ? `
                            <div class="text-xs text-gray-500 mb-2">
                                ‚è∞ ${goal.deadline}
                            </div>
                        ` : ''}
                        
                        ${isUserGoal ? `
                            <div class="flex gap-2 mt-2">
                                <button onclick="updateGoalProgress(${index - goals.length}, 1)" class="bg-green-500 text-white text-xs px-2 py-1 rounded hover:bg-green-600 transition-colors">
                                    +1
                                </button>
                                <button onclick="updateGoalProgress(${index - goals.length}, -1)" class="bg-red-500 text-white text-xs px-2 py-1 rounded hover:bg-red-600 transition-colors">
                                    -1
                                </button>
                                <button onclick="updateGoalProgress(${index - goals.length}, 5)" class="bg-blue-500 text-white text-xs px-2 py-1 rounded hover:bg-blue-600 transition-colors">
                                    +5
                                </button>
                                <button onclick="resetGoalProgress(${index - goals.length})" class="bg-gray-500 text-white text-xs px-2 py-1 rounded hover:bg-gray-600 transition-colors">
                                    ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            achievementsSection.innerHTML = `
                <div class="grid grid-cols-1 gap-6">
                    <div>
                        <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                            üèÜ <span class="ml-2">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>
                        </h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                            ${achievementsHtml}
                        </div>
                    </div>
                    
                    <div>
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-bold text-gray-800">üéØ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h4>
                            <button onclick="showAddGoalModal()" class="bg-blue-500 text-white text-sm px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors shadow-md">
                                ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
                            </button>
                        </div>
                        <div>
                            ${allGoals.length > 0 ? goalsHtml : `
                                <div class="text-center text-gray-500 py-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                                    <div class="text-4xl mb-2">üéØ</div>
                                    <p class="mb-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</p>
                                    <button onclick="showAddGoalModal()" class="text-blue-500 hover:text-blue-700 underline">
                                        ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏£‡∏Å!
                                    </button>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
            
            console.log('Achievements and goals loaded successfully');
        }
        
        // Goals CRUD Functions
        function showAddGoalModal() {
            const modal = createGoalModal();
            document.body.appendChild(modal);
            modal.style.display = 'flex';
        }

        function createGoalModal(goal = null, isEdit = false) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.onclick = (e) => { if (e.target === modal) closeGoalModal(); };
            
            const icons = ['üéØ', 'üìö', 'üí™', 'üèÉ', 'üí∞', 'üé®', '‚ö°', 'üåü', 'üî•', 'üìà', '‚ú®', 'üéµ', 'üçé', 'üßò'];
            
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md mx-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-800">
                            ${isEdit ? '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢' : '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà'}
                        </h3>
                        <button onclick="closeGoalModal()" class="text-gray-500 hover:text-gray-700 text-xl">
                            ‚úï
                        </button>
                    </div>
                    
                    <form id="goalForm" onsubmit="saveGoal(event, ${isEdit})">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô</label>
                                <div class="grid grid-cols-7 gap-2">
                                    ${icons.map(icon => `
                                        <button type="button" onclick="selectIcon('${icon}')" 
                                                class="icon-option p-2 text-xl text-center border rounded hover:bg-blue-50 hover:border-blue-300 transition-colors
                                                ${(goal?.icon === icon || (!goal && icon === 'üéØ')) ? 'bg-blue-100 border-blue-400' : 'border-gray-300'}">
                                            ${icon}
                                        </button>
                                    `).join('')}
                                </div>
                                <input type="hidden" id="selectedIcon" value="${goal?.icon || 'üéØ'}">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1" for="goalTitle">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</label>
                                <input type="text" id="goalTitle" required maxlength="100" 
                                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ 10 ‡πÄ‡∏•‡πà‡∏°" 
                                       value="${goal?.title || ''}">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1" for="goalDescription">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                                <textarea id="goalDescription" maxlength="200" rows="3"
                                          class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                          placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...">${goal?.description || ''}</textarea>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1" for="goalProgress">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
                                    <input type="number" id="goalProgress" min="0" required
                                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                           placeholder="0" value="${goal?.progress || 0}">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1" for="goalTarget">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</label>
                                    <input type="number" id="goalTarget" min="1" required
                                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                           placeholder="10" value="${goal?.target || ''}">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1" for="goalDeadline">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à (‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)</label>
                                <input type="date" id="goalDeadline"
                                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       value="${goal?.deadlineDate || ''}">
                            </div>
                            
                            <div class="flex gap-3 pt-4">
                                <button type="submit" class="flex-1 bg-blue-500 text-white py-3 px-4 rounded-lg hover:bg-blue-600 transition-colors font-medium">
                                    ${isEdit ? 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢'}
                                </button>
                                <button type="button" onclick="closeGoalModal()" class="px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            `;
            
            return modal;
        }

        function selectIcon(icon) {
            document.getElementById('selectedIcon').value = icon;
            document.querySelectorAll('.icon-option').forEach(btn => {
                btn.classList.remove('bg-blue-100', 'border-blue-400');
                btn.classList.add('border-gray-300');
            });
            event.target.classList.add('bg-blue-100', 'border-blue-400');
            event.target.classList.remove('border-gray-300');
        }

        function saveGoal(event, isEdit = false) {
            event.preventDefault();
            
            const formData = {
                icon: document.getElementById('selectedIcon').value,
                title: document.getElementById('goalTitle').value.trim(),
                description: document.getElementById('goalDescription').value.trim(),
                progress: parseInt(document.getElementById('goalProgress').value) || 0,
                target: parseInt(document.getElementById('goalTarget').value) || 1,
                deadline: document.getElementById('goalDeadline').value,
                deadlineDate: document.getElementById('goalDeadline').value,
                created: new Date().toISOString()
            };
            
            // Format deadline display
            if (formData.deadline) {
                const date = new Date(formData.deadline);
                formData.deadline = date.toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } else {
                formData.deadline = null;
            }
            
            // Validation
            if (!formData.title) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢', 'warning');
                return;
            }
            
            if (formData.target < 1) {
                showNotification('‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0', 'warning');
                return;
            }
            
            if (formData.progress > formData.target) {
                formData.progress = formData.target;
            }
            
            try {
                if (isEdit) {
                    // Update existing goal
                    userGoals[editingGoalIndex] = formData;
                    showNotification('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üéØ', 'success');
                } else {
                    // Add new goal
                    userGoals.push(formData);
                    showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üéØ', 'success');
                }
                
                // Save to localStorage
                localStorage.setItem('userGoals', JSON.stringify(userGoals));
                
                // Refresh display
                loadAchievements();
                closeGoalModal();
                
            } catch (error) {
                console.error('Error saving goal:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'error');
            }
        }

        function editGoal(index) {
            editingGoalIndex = index;
            const goal = userGoals[index];
            const modal = createGoalModal(goal, true);
            document.body.appendChild(modal);
            modal.style.display = 'flex';
        }

        function deleteGoal(index) {
            const goal = userGoals[index];
            
            if (confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ "${goal.title}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                userGoals.splice(index, 1);
                localStorage.setItem('userGoals', JSON.stringify(userGoals));
                loadAchievements();
                showNotification('‡∏•‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            }
        }

        function updateGoalProgress(index, change) {
            const goal = userGoals[index];
            goal.progress = Math.max(0, Math.min(goal.target, goal.progress + change));
            
            localStorage.setItem('userGoals', JSON.stringify(userGoals));
            loadAchievements();
            
            // Show celebration for completed goals
            if (goal.progress === goal.target && change > 0) {
                showNotification(`üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ "${goal.title}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!`, 'success');
            }
        }

        function resetGoalProgress(index) {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                userGoals[index].progress = 0;
                localStorage.setItem('userGoals', JSON.stringify(userGoals));
                loadAchievements();
                showNotification('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'info');
            }
        }

        function closeGoalModal() {
            const modal = document.querySelector('.fixed.inset-0');
            if (modal) {
                modal.remove();
            }
            editingGoalIndex = -1;
        }

        // Create Achievements from Analytics Data
        function createAchievementsFromAnalytics(habitData, taskData) {
            const achievements = [];
            
            // Task-based achievements
            if (taskData) {
                // Task Master achievement
                achievements.push({
                    icon: 'üèÜ',
                    title: 'Task Master',
                    description: `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏ö ${taskData.total_tasks || 0} ‡∏á‡∏≤‡∏ô`,
                    earned: (taskData.total_tasks || 0) >= 100,
                    progress: taskData.total_tasks || 0,
                    target: 100,
                    type: 'task_creation'
                });
                
                // Completion Rate achievement
                achievements.push({
                    icon: '‚ö°',
                    title: 'Efficiency Expert',
                    description: '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ 80%',
                    earned: (taskData.completion_rate || 0) >= 80,
                    progress: Math.round(taskData.completion_rate || 0),
                    target: 80,
                    type: 'completion_rate'
                });
                
                // Completed tasks achievement
                achievements.push({
                    icon: '‚úÖ',
                    title: 'Completionist',
                    description: '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß 50+ ‡∏á‡∏≤‡∏ô',
                    earned: (taskData.completed_tasks || 0) >= 50,
                    progress: taskData.completed_tasks || 0,
                    target: 50,
                    type: 'completed_tasks'
                });
            }
            
            // Habit-based achievements
            if (habitData) {
                // Habit Consistency achievement
                achievements.push({
                    icon: 'üî•',
                    title: 'Habit Master',
                    description: '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Ç‡∏≠‡∏á‡∏ô‡∏¥‡∏™‡∏±‡∏¢‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ 75%',
                    earned: (habitData.achievement_rate || 0) >= 75,
                    progress: Math.round(habitData.achievement_rate || 0),
                    target: 75,
                    type: 'habit_consistency'
                });
                
                // Streak achievement
                achievements.push({
                    icon: 'üèÉ‚Äç‚ôÇÔ∏è',
                    title: 'Streak Champion',
                    description: '‡∏ó‡∏≥‡∏ô‡∏¥‡∏™‡∏±‡∏¢‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á 7+ ‡∏ß‡∏±‡∏ô',
                    earned: (habitData.longest_streak || 0) >= 7,
                    progress: habitData.longest_streak || 0,
                    target: 7,
                    streak: habitData.longest_streak || 0,
                    type: 'habit_streak'
                });
                
                // Multiple habits achievement
                achievements.push({
                    icon: 'üìö',
                    title: 'Habit Builder',
                    description: '‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ô‡∏¥‡∏™‡∏±‡∏¢‡∏Ñ‡∏£‡∏ö 5+ ‡∏≠‡∏¢‡πà‡∏≤‡∏á',
                    earned: (habitData.total_habits || 0) >= 5,
                    progress: habitData.total_habits || 0,
                    target: 5,
                    type: 'multiple_habits'
                });
            }
            
            return achievements;
        }
        
        // Test Habits API endpoints
        async function testHabitsAPI() {
            console.log('Testing Habits API endpoints...');
            
            try {
                // Test habits analytics endpoint
                console.log('Testing /analytics/habits...');
                const habitAnalytics = await apiRequest('/analytics/habits');
                console.log('Habit Analytics Response:', habitAnalytics);
                
                // Test habits CRUD endpoints
                console.log('Testing /habits...');
                const habits = await apiRequest('/habits');
                console.log('Habits List Response:', habits);
                
                // Test task analytics for comparison
                console.log('Testing /analytics/tasks...');
                const taskAnalytics = await apiRequest('/analytics/tasks');
                console.log('Task Analytics Response:', taskAnalytics);
                
                showNotification('API tests completed! Check console for details.', 'success');
                return { habitAnalytics, habits, taskAnalytics };
                
            } catch (error) {
                console.error('API Test Error:', error);
                showNotification('API test failed: ' + error.message, 'error');
                return null;
            }
        }
        
        // Create a test habit (for testing CRUD operations)
        async function createTestHabit() {
            console.log('Creating test habit...');
            
            const testHabit = {
                title: "‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥ 8 ‡πÅ‡∏Å‡πâ‡∏ß‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô",
                description: "‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 8 ‡πÅ‡∏Å‡πâ‡∏ß‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏±‡∏ô",
                frequency: "daily",
                category: "health",
                target_count: 8,
                reminder_time: "08:00"
            };
            
            try {
                const result = await apiRequest('/habits', 'POST', testHabit);
                console.log('Test habit created:', result);
                showNotification('Test habit created successfully!', 'success');
                return result;
            } catch (error) {
                console.error('Failed to create test habit:', error);
                showNotification('Failed to create test habit: ' + error.message, 'error');
                return null;
            }
        }
        
        // Retry loading functions
        async function retryLoadUserProfile() {
            showSectionLoading('profile-info-section', 'Retrying...');
            await loadUserProfile();
        }
        
        async function retryLoadRecentActivity() {
            showSectionLoading('recent-activity-section', 'Retrying...');
            await loadRecentActivity();
        }
        
        async function retryLoadAnalytics() {
            showSectionLoading('analytics-section', 'Retrying...');
            await loadAnalytics();
        }
        
        async function retryLoadAchievements() {
            showSectionLoading('achievements-section', 'Retrying...');
            loadAchievements();
        }
        
        // Toggle Edit Mode
        function toggleEditMode() {
            if (!userInfo) return;
            
            isEditMode = !isEditMode;
            const editBtn = document.getElementById('edit-profile-btn');
            const profileCard = document.querySelector('#profile-info-section').closest('.profile-card');
            
            if (isEditMode) {
                editBtn.innerHTML = '‚úñÔ∏è Cancel Edit';
                editBtn.className = 'btn-cancel px-4 py-2 rounded-lg font-medium transition-colors';
                profileCard.classList.add('edit-mode');
                
                // Switch to edit form
                const profileSection = document.getElementById('profile-info-section');
                profileSection.innerHTML = createProfileForm(userInfo.user, true);
                
                // Add real-time validation
                setupFormValidation();
            } else {
                editBtn.innerHTML = '‚úèÔ∏è Edit Profile';
                editBtn.className = 'bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors';
                profileCard.classList.remove('edit-mode');
                
                // Switch back to view mode
                displayUserProfile(userInfo);
            }
        }
        
        // Setup form validation
        function setupFormValidation() {
            const emailInput = document.getElementById('edit-email');
            const displayNameInput = document.getElementById('edit-display-name');
            const bioInput = document.getElementById('edit-bio');
            
            // Email validation
            if (emailInput) {
                emailInput.addEventListener('blur', function() {
                    const email = this.value.trim();
                    if (email && !isValidEmail(email)) {
                        this.style.borderColor = '#ef4444';
                        showNotification('Please enter a valid email address', 'warning');
                    } else {
                        this.style.borderColor = '#d1d5db';
                    }
                });
            }
            
            // Display name validation
            if (displayNameInput) {
                displayNameInput.addEventListener('input', function() {
                    if (this.value.length > 100) {
                        this.value = this.value.substring(0, 100);
                        showNotification('Display name cannot exceed 100 characters', 'warning');
                    }
                });
            }
            
            // Bio validation
            if (bioInput) {
                bioInput.addEventListener('input', function() {
                    if (this.value.length > 500) {
                        this.value = this.value.substring(0, 500);
                        showNotification('Bio cannot exceed 500 characters', 'warning');
                    }
                });
            }
        }
        
        // Email validation helper
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        
        // Save Profile (PATCH method)
        async function saveProfile() {
            const displayName = document.getElementById('edit-display-name')?.value;
            const email = document.getElementById('edit-email')?.value;
            const location = document.getElementById('edit-location')?.value;
            const bio = document.getElementById('edit-bio')?.value;
            
            const updateData = {};
            
            // Only include fields that have valid string values
            if (displayName && displayName.trim() !== '') {
                updateData.display_name = displayName.trim();
            }
            
            if (email && email.trim() !== '') {
                if (!isValidEmail(email.trim())) {
                    showNotification('Please enter a valid email address', 'error');
                    return;
                }
                updateData.email = email.trim();
            }
            
            if (location && location.trim() !== '') {
                updateData.location = location.trim();
            }
            
            if (bio && bio.trim() !== '') {
                updateData.bio = bio.trim();
            }
            
            // Validate that we have at least one field to update
            if (Object.keys(updateData).length === 0) {
                showNotification('Please fill in at least one field to update', 'warning');
                return;
            }
            
            console.log('Update data to send:', updateData);
            showNotification('Updating profile...', 'info');
            
            try {
                // Check if backend is available
                const backendConnected = await testBackendConnection();
                
                if (backendConnected) {
                    // Try real API call
                    const jsonString = JSON.stringify(updateData);
                    console.log('JSON to send:', jsonString);
                    
                    const result = await apiRequest('/user/profile', 'PATCH', updateData);
                    
                    if (result && result.user) {
                        console.log('Profile update successful:', result);
                        
                        // Update local user info with response from server
                        Object.assign(userInfo.user, result.user);
                        
                        showNotification('Profile updated successfully!', 'success');
                    } else {
                        throw new Error('Invalid response from server');
                    }
                } else {
                    // Demo mode - update locally only
                    console.log('Demo mode: Updating profile locally');
                    Object.assign(userInfo.user, updateData);
                    showNotification('Demo mode: Profile updated locally!', 'info');
                }
                
                // Update display and storage regardless of mode
                displayUserProfile(userInfo);
                toggleEditMode();
                localStorage.setItem('userProfile', JSON.stringify(userInfo));
                
            } catch (error) {
                console.error('Failed to update profile:', error);
                
                if (error.message.includes('NaN')) {
                    showNotification('Data validation error. Please check your input fields.', 'error');
                } else if (error.message.includes('401')) {
                    showNotification('Authentication failed. Please login again.', 'error');
                    logout();
                } else {
                    // Fallback to demo mode if API fails
                    console.log('API failed, falling back to demo mode');
                    Object.assign(userInfo.user, updateData);
                    displayUserProfile(userInfo);
                    toggleEditMode();
                    localStorage.setItem('userProfile', JSON.stringify(userInfo));
                    showNotification('Demo mode: Profile updated locally (API unavailable)', 'warning');
                }
            }
        }
        
        // Cancel Edit
        function cancelEdit() {
            if (confirm('Are you sure you want to cancel? All changes will be lost.')) {
                // Restore original data
                userInfo = JSON.parse(JSON.stringify(originalUserData));
                toggleEditMode();
            }
        }
        
        // Change Avatar
        function changeAvatar() {
            const avatars = ['üë§', 'üë®', 'üë©', 'üßë', 'üë®‚Äçüíª', 'üë©‚Äçüíª', 'üë®‚Äçüé®', 'üë©‚Äçüé®', 'üßô‚Äç‚ôÇÔ∏è', 'üßô‚Äç‚ôÄÔ∏è'];
            const currentAvatar = document.querySelector('.profile-avatar').textContent;
            let nextIndex = avatars.indexOf(currentAvatar) + 1;
            if (nextIndex >= avatars.length) nextIndex = 0;
            
            document.querySelector('.profile-avatar').textContent = avatars[nextIndex];
            showNotification('Avatar updated!', 'success');
        }
        
        // Utility Functions
        function escapeHtml(text) {
            if (!text || typeof text !== 'string') return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }
        
        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} minutes ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} hours ago`;
            return `${Math.floor(diffInSeconds / 86400)} days ago`;
        }
        
        function getActivityIcon(eventType) {
            const icons = {
                'task_created': '‚ûï',
                'task_completed': '‚úÖ',
                'task_updated': '‚úèÔ∏è',
                'task_deleted': 'üóëÔ∏è',
                'habit_tracked': 'üìà',
                'user_login': 'üîê',
                'default': 'üìù'
            };
            return icons[eventType] || icons.default;
        }
        
        // Update connection status indicator
        function updateConnectionStatus(connected) {
            const statusContainer = document.getElementById('connection-status');
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            
            if (connected) {
                statusContainer.className = 'flex items-center space-x-2 px-3 py-1 rounded-full text-sm bg-green-100 text-green-800';
                statusIndicator.className = 'w-2 h-2 rounded-full bg-green-500';
                statusText.textContent = 'Connected to Server';
            } else {
                statusContainer.className = 'flex items-center space-x-2 px-3 py-1 rounded-full text-sm bg-orange-100 text-orange-800';
                statusIndicator.className = 'w-2 h-2 rounded-full bg-orange-500';
                statusText.textContent = 'Demo Mode';
            }
        }
        
        // Update user greeting
        function updateUserGreeting(username) {
            const userGreeting = document.getElementById('user-greeting');
            if (userGreeting) {
                userGreeting.textContent = `Welcome, ${username}`;
            }
        }
        
        // Notification System
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${getNotificationClasses(type)}`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <span class="mr-2">${getNotificationIcon(type)}</span>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        ‚úï
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }
        
        function getNotificationClasses(type) {
            switch (type) {
                case 'success': return 'bg-green-500 text-white';
                case 'error': return 'bg-red-500 text-white';
                case 'warning': return 'bg-orange-500 text-white';
                case 'info': return 'bg-blue-500 text-white';
                default: return 'bg-gray-500 text-white';
            }
        }
        
        function getNotificationIcon(type) {
            switch (type) {
                case 'success': return '‚úÖ';
                case 'error': return '‚ùå';
                case 'warning': return '‚ö†Ô∏è';
                case 'info': return '‚ÑπÔ∏è';
                default: return 'üìù';
            }
        }
        
        function logout() {
            confirmLogout();
        }
        
        // Initialize profile page
        async function initProfile() {
            // Skip token check for demo mode
            // if (!token) {
            //     window.location.href = 'index.html';
            //     return;
            // }
            
            try {
                // Show initial loading states
                showSectionLoading('profile-info-section', 'Loading profile...');
                showSectionLoading('quick-stats-section', 'Loading stats...');
                showSectionLoading('recent-activity-section', 'Loading activity...');
                showSectionLoading('analytics-section', 'Loading analytics...');
                showSectionLoading('achievements-section', 'Loading achievements...');
                
                // Test backend connection
                console.log('Testing backend connection...');
                const backendConnected = await testBackendConnection();
                updateConnectionStatus(backendConnected);
                
                if (backendConnected) {
                    console.log('Backend connected - using real API');
                } else {
                    console.log('Backend not available - using demo mode');
                }
                
                // Check for saved profile data
                const savedProfile = localStorage.getItem('userProfile');
                if (savedProfile) {
                    const parsedProfile = JSON.parse(savedProfile);
                    userInfo = parsedProfile;
                    originalUserData = JSON.parse(JSON.stringify(parsedProfile));
                    console.log('Found cached profile data');
                }
                
                // Step 1: Load user profile first
                console.log('Step 1: Loading user profile...');
                const profileLoaded = await loadUserProfile();
                
                if (!profileLoaded) {
                    showNotification('Failed to load user profile. Please try refreshing the page.', 'error');
                    return;
                }
                
                // Add delay between requests to avoid overwhelming the server
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Step 2: Load recent activity (mock for demo)
                console.log('Step 2: Loading recent activity...');
                await loadRecentActivity();
                
                // Add delay between requests
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Step 3: Load analytics (mock for demo)
                console.log('Step 3: Loading analytics...');
                await loadAnalytics();
                
                // Step 4: Load achievements (mock data - instant)
                console.log('Step 4: Loading achievements...');
                loadAchievements();
                
                console.log('Profile initialization complete');
                showNotification('Profile loaded successfully!', 'success');
                
            } catch (error) {
                console.error('Error initializing profile:', error);
                showNotification('Failed to load profile data: ' + error.message, 'error');
                
                // Show error states for sections that failed
                showSectionError('profile-info-section', 'Failed to load profile', 'retryLoadUserProfile');
                showSectionError('recent-activity-section', 'Failed to load activity', 'retryLoadRecentActivity');
                showSectionError('analytics-section', 'Failed to load analytics', 'retryLoadAnalytics');
            }
        }
        
        // Start the profile page
        document.addEventListener('DOMContentLoaded', function() {
            initProfile();
            
            // Add edit profile click handler
            const editBtn = document.getElementById('editProfileBtn');
            if (editBtn) {
                editBtn.addEventListener('click', function() {
                    isEditMode = true;
                    loadProfile();
                });
            }
            
            // Add save profile click handler
            document.addEventListener('click', function(e) {
                if (e.target && e.target.id === 'saveProfileBtn') {
                    e.preventDefault();
                    saveProfile();
                }
                
                // Change password handler
                if (e.target && e.target.id === 'changePasswordBtn') {
                    e.preventDefault();
                    const currentPassword = document.getElementById('currentPassword').value;
                    const newPassword = document.getElementById('newPassword').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;
                    
                    if (newPassword !== confirmPassword) {
                        showNotification('New passwords do not match', 'warning');
                        return;
                    }
                    
                    changePassword(currentPassword, newPassword).then(success => {
                        if (success) {
                            // Clear password fields
                            document.getElementById('currentPassword').value = '';
                            document.getElementById('newPassword').value = '';
                            document.getElementById('confirmPassword').value = '';
                        }
                    });
                }
                
                // Cancel edit handler
                if (e.target && e.target.id === 'cancelEditBtn') {
                    e.preventDefault();
                    isEditMode = false;
                    loadProfile();
                }
            });
        });
        
        // Edit Mode Functions
        function toggleEditMode() {
            isEditMode = !isEditMode;
            if (userInfo) {
                displayUserProfile(userInfo);
            }
            
            const editBtn = document.getElementById('edit-profile-btn');
            if (editBtn) {
                editBtn.textContent = isEditMode ? '‚ùå Cancel' : '‚úèÔ∏è Edit Profile';
                editBtn.onclick = isEditMode ? cancelEdit : toggleEditMode;
            }
        }
        
        function cancelEdit() {
            isEditMode = false;
            if (userInfo) {
                displayUserProfile(userInfo);
            }
            
            const editBtn = document.getElementById('edit-profile-btn');
            if (editBtn) {
                editBtn.textContent = '‚úèÔ∏è Edit Profile';
                editBtn.onclick = toggleEditMode;
            }
        }
        
        async function saveProfile() {
            try {
                // Get form data
                const displayName = document.getElementById('edit-display-name')?.value?.trim();
                const email = document.getElementById('edit-email')?.value?.trim();
                const location = document.getElementById('edit-location')?.value?.trim();
                const bio = document.getElementById('edit-bio')?.value?.trim();
                
                const profileData = {
                    display_name: displayName,
                    email: email,
                    location: location,
                    bio: bio
                };
                
                // Validate data
                if (email && !isValidEmail(email)) {
                    showNotification('Please enter a valid email address', 'warning');
                    return;
                }
                
                // Try to save to API
                const backendConnected = await testBackendConnection();
                
                if (backendConnected) {
                    try {
                        const result = await apiRequest('/user/update', 'PATCH', profileData);
                        if (result) {
                            // Update local user info
                            userInfo.user = { ...userInfo.user, ...profileData };
                            originalUserData = JSON.parse(JSON.stringify(userInfo));
                            localStorage.setItem('userProfile', JSON.stringify(userInfo));
                            
                            showNotification('Profile updated successfully!', 'success');
                        }
                    } catch (error) {
                        console.warn('API update failed:', error);
                        showNotification('API not available, saving locally', 'warning');
                        
                        // Save locally as fallback
                        userInfo.user = { ...userInfo.user, ...profileData };
                        localStorage.setItem('userProfile', JSON.stringify(userInfo));
                        showNotification('Profile saved locally', 'info');
                    }
                } else {
                    // Save to localStorage only
                    userInfo.user = { ...userInfo.user, ...profileData };
                    localStorage.setItem('userProfile', JSON.stringify(userInfo));
                    showNotification('Profile saved locally (demo mode)', 'info');
                }
                
                // Exit edit mode
                cancelEdit();
                
            } catch (error) {
                console.error('Failed to save profile:', error);
                showNotification('Failed to save profile: ' + error.message, 'error');
            }
        }
        
        function isValidEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }
        
        function changeAvatar() {
            showNotification('Avatar change feature coming soon!', 'info');
        }
    </script>

    <!-- Vercel Analytics -->
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
</body>
</html>
