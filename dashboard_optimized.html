<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ToDo List App</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÖ</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="common-notifications.js"></script>
    <style>
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .excel-bg {
            background: #f3f4f6;
            min-height: 100vh;
        }
        
        .header-gradient {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
        }
        
        .excel-card {
            background: white;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
        
        .stats-widget {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }
        
        .stats-widget:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
        }
        
        .calendar-header {
            background: #f8fafc;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e5e7eb;
        }
        
        .calendar-day {
            background: white;
            min-height: 80px;
            padding: 8px;
            border: none;
            position: relative;
        }
        
        .calendar-day.today {
            background: #eff6ff;
            border: 2px solid #3b82f6;
        }
        
        .calendar-day.other-month {
            background: #f9fafb;
            color: #9ca3af;
        }
        
        .task-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: inline-block;
            margin: 1px;
        }
        
        .task-dot.high { background: #ef4444; }
        .task-dot.medium { background: #f59e0b; }
        .task-dot.low { background: #10b981; }
        
        .task-item {
            border-left: 4px solid #e5e7eb;
            background: white;
            border-radius: 0 8px 8px 0;
            margin-bottom: 8px;
            padding: 12px 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .task-item.high-priority {
            border-left-color: #ef4444;
        }
        
        .task-item.medium-priority {
            border-left-color: #f59e0b;
        }
        
        .task-item.low-priority {
            border-left-color: #10b981;
        }
        
        .priority-badge {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .priority-high {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .priority-medium {
            background: #fef3c7;
            color: #d97706;
        }
        
        .priority-low {
            background: #d1fae5;
            color: #059669;
        }
        
        .nav-professional {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .nav-link {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s ease;
            text-decoration: none;
            color: #374151;
        }
        
        .nav-link:hover {
            background: #f3f4f6;
        }
        
        .nav-link.active {
            background: #3b82f6;
            color: white;
        }
        
        .btn-professional {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-professional:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 8px 16px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        /* Responsive Design */
        @media (max-width: 1024px) {
            .container {
                padding: 0 16px;
            }
            
            .nav-professional {
                padding: 12px 16px;
            }
            
            .nav-professional .container {
                flex-direction: column;
                gap: 16px;
            }
            
            .nav-professional h1 {
                font-size: 1.5rem;
            }
            
            .nav-professional .flex.items-center.space-x-2 {
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px;
            }
            
            .nav-link {
                padding: 6px 12px;
                font-size: 0.875rem;
            }
            
            .excel-card {
                padding: 16px;
            }
            
            .stats-widget {
                padding: 16px;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 0 12px;
            }
            
            .grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-4 {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .grid.grid-cols-1.lg\\:grid-cols-3 {
                grid-template-columns: 1fr;
            }
            
            .grid.grid-cols-1.lg\\:grid-cols-2 {
                grid-template-columns: 1fr;
            }
            
            .excel-card {
                padding: 12px;
            }
            
            .stats-widget {
                padding: 12px;
            }
            
            .text-3xl {
                font-size: 1.875rem;
            }
            
            .text-2xl {
                font-size: 1.5rem;
            }
            
            .text-xl {
                font-size: 1.125rem;
            }
            
            .task-item {
                padding: 10px 12px;
                margin-bottom: 6px;
            }
            
            .calendar-grid {
                gap: 4px;
            }
            
            .nav-professional .flex.items-center.space-x-2 {
                grid-template-columns: repeat(2, 1fr);
                display: grid;
                gap: 8px;
            }
        }
        
        @media (max-width: 480px) {
            .grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-4 {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .nav-professional .flex.items-center.space-x-2 {
                grid-template-columns: 1fr;
                gap: 6px;
            }
            
            .nav-link {
                text-align: center;
                padding: 8px 4px;
                font-size: 0.75rem;
            }
            
            .excel-card {
                padding: 10px;
            }
            
            .stats-widget {
                padding: 10px;
            }
            
            .text-lg {
                font-size: 1rem;
            }
            
            .task-item {
                padding: 8px 10px;
                margin-bottom: 4px;
            }
            
            .calendar-grid {
                gap: 2px;
                grid-template-columns: repeat(7, 1fr);
            }
            
            .btn-primary,
            .btn-secondary {
                width: 100%;
                margin-bottom: 8px;
                padding: 8px 12px;
                font-size: 0.875rem;
            }
        }
        
        /* iPad Air specific adjustments */
        @media (min-width: 820px) and (max-width: 1024px) {
            .grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-4 {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .grid.grid-cols-1.lg\\:grid-cols-3 {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .nav-professional .flex.items-center.space-x-2 {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .excel-card {
                padding: 18px;
            }
        }
    </style>
</head>
<body class="excel-bg">
    <div id="app" class="min-h-screen">
        <!-- Navigation -->
        <nav class="nav-professional p-4">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-8">
                    <h1 class="text-2xl font-bold text-gray-800">üçÖ ToDo List</h1>
                    <div class="flex items-center space-x-2">
                        <a href="dashboard.html" class="nav-link active">üìä Dashboard</a>
                        <a href="tasks.html" class="nav-link">üìã Tasks</a>
                        <a href="calendar.html" class="nav-link">üìÖ Calendar</a>
                        <a href="analytics.html" class="nav-link">üìä Analytics</a>
                        <a href="profile.html" class="nav-link">üë§ Profile</a>
                        <a href="settings.html" class="nav-link">‚öôÔ∏è Settings</a>
                    </div>
                </div>
                <div id="nav-menu" class="flex items-center space-x-4">
                    <span id="user-greeting" class="text-gray-700 font-medium"></span>
                    <button onclick="logout()" class="btn-professional">
                        üì§ Logout
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container mx-auto p-6">
            <div id="content" class="fade-in">
                <!-- Dashboard content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="api-loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white p-8 rounded-lg shadow-lg text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <div class="loading-text text-lg font-medium text-gray-800">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            <div class="loading-subtext text-sm text-gray-600 mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container" class="fixed top-4 right-4 z-50"></div>

    <!-- Vercel Analytics -->
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>

    <script>
        // Global state
        let currentUser = null;
        let token = localStorage.getItem('token');
        const API_BASE = 'https://to-do-list-api-app.vercel.app/api/v1';

        // Utility functions
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `p-4 rounded-lg shadow-lg text-white mb-2 transition-all duration-300 ${
                type === 'error' ? 'bg-red-500' : 
                type === 'success' ? 'bg-green-500' : 'bg-blue-500'
            }`;
            toast.textContent = message;
            
            const container = document.getElementById('toast-container');
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => container.removeChild(toast), 300);
            }, 3000);
        }

        // Simple API call function
        async function apiCall(endpoint, options = {}) {
            const config = {
                method: options.method || 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` })
                },
                ...(options.body && { body: options.body }),
                ...options
            };

            const response = await fetch(`${API_BASE}${endpoint}`, config);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            return await response.json();
        }

        function logout() {
            confirmLogout();
        }

        // Helper functions
        function getThisWeekTasks(tasks) {
            const today = new Date();
            const weekStart = new Date(today.setDate(today.getDate() - today.getDay()));
            const weekEnd = new Date(today.setDate(today.getDate() - today.getDay() + 6));
            
            return tasks.filter(task => {
                if (!task.due_date) return false;
                const dueDate = new Date(task.due_date);
                return dueDate >= weekStart && dueDate <= weekEnd;
            });
        }

        function getCompletedThisWeek(tasks) {
            const thisWeekTasks = getThisWeekTasks(tasks);
            return thisWeekTasks.filter(task => task.is_completed).length;
        }

        function getTasksByPriority(tasks, priority) {
            const priorityNum = priority === 'high' ? 3 : priority === 'medium' ? 2 : 1;
            return tasks.filter(task => task.priority === priorityNum);
        }

        function getTodayTasks(tasks) {
            const today = new Date().toISOString().split('T')[0];
            return tasks.filter(task => {
                if (!task.due_date) return false;
                const taskDate = new Date(task.due_date).toISOString().split('T')[0];
                return taskDate === today;
            });
        }

        function getOverdueTasks(tasks) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return tasks.filter(task => {
                if (!task.due_date || task.is_completed) return false;
                const dueDate = new Date(task.due_date);
                return dueDate < today;
            });
        }

        function getUpcomingTasks(tasks) {
            const today = new Date();
            const nextWeek = new Date();
            nextWeek.setDate(today.getDate() + 7);
            
            return tasks.filter(task => {
                if (!task.due_date || task.is_completed) return false;
                const dueDate = new Date(task.due_date);
                return dueDate > today && dueDate <= nextWeek;
            });
        }

        function getTasksForDate(tasks, date) {
            const dateStr = date.toISOString().split('T')[0];
            return tasks.filter(task => {
                if (!task.due_date) return false;
                const taskDate = new Date(task.due_date).toISOString().split('T')[0];
                return taskDate === dateStr;
            });
        }

        function generateCalendar(date, tasks) {
            const year = date.getFullYear();
            const month = date.getMonth();
            const today = new Date();
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const endDate = new Date(lastDay);
            endDate.setDate(endDate.getDate() + (6 - lastDay.getDay()));
            
            let html = `
                <div class="calendar-header p-3">
                    <div class="calendar-grid text-center font-medium text-gray-600">
                        <div class="p-2">Sun</div>
                        <div class="p-2">Mon</div>
                        <div class="p-2">Tue</div>
                        <div class="p-2">Wed</div>
                        <div class="p-2">Thu</div>
                        <div class="p-2">Fri</div>
                        <div class="p-2">Sat</div>
                    </div>
                </div>
                <div class="calendar-grid">
            `;
            
            const current = new Date(startDate);
            while (current <= endDate) {
                const isToday = current.toDateString() === today.toDateString();
                const isCurrentMonth = current.getMonth() === month;
                const dayTasks = getTasksForDate(tasks, current);
                
                html += `
                    <div class="calendar-day ${isToday ? 'today' : ''} ${!isCurrentMonth ? 'other-month' : ''}">
                        <div class="font-medium mb-1">${current.getDate()}</div>
                        <div class="flex flex-wrap">
                            ${dayTasks.map(task => {
                                const priorityText = task.priority === 3 ? 'high' : task.priority === 2 ? 'medium' : 'low';
                                return `<span class="task-dot ${priorityText}" title="${task.task_name || ''}"></span>`;
                            }).join('')}
                        </div>
                    </div>
                `;
                
                current.setDate(current.getDate() + 1);
            }
            
            html += '</div>';
            return html;
        }

        function generateTaskList(tasks) {
            if (tasks.length === 0) {
                return '<div class="text-center text-gray-500 py-8">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</div>';
            }
            
            function getPriorityText(priority) {
                switch(priority) {
                    case 3: return 'high';
                    case 2: return 'medium';
                    case 1: return 'low';
                    default: return 'low';
                }
            }
            
            return tasks.map(task => {
                const priorityText = getPriorityText(task.priority);
                return `
                <div class="task-item ${priorityText}-priority">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3">
                                <input type="checkbox" ${task.is_completed ? 'checked' : ''} 
                                       onchange="toggleTask(${task.id}, this.checked)"
                                       class="w-4 h-4 text-blue-600 rounded">
                                <h4 class="font-medium text-gray-900 ${task.is_completed ? 'line-through' : ''}">${task.task_name || 'Untitled Task'}</h4>
                                <span class="priority-badge priority-${priorityText}">${priorityText}</span>
                            </div>
                            ${task.description ? `<p class="text-sm text-gray-600 mt-1 ml-7">${task.description}</p>` : ''}
                            ${task.due_date ? `<p class="text-xs text-gray-500 mt-1 ml-7">‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î: ${new Date(task.due_date).toLocaleDateString()}</p>` : ''}
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="editTask(${task.id})" class="text-blue-600 hover:text-blue-800">‚úèÔ∏è</button>
                            <button onclick="deleteTask(${task.id})" class="text-red-600 hover:text-red-800">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `;}).join('');
        }

        // Sequential data loading - Load user info first, then other data
        async function loadDashboardData() {
            try {
                showLoadingOverlay('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ...');
                
                // Step 1: Load user info first (critical)
                let userInfo = null;
                try {
                    userInfo = await apiCall('/user/info');
                    currentUser = userInfo.user;
                    updateUserGreeting(userInfo.user.username);
                    showToast(`‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ${userInfo.user.username}!`, 'success');
                } catch (error) {
                    console.warn('Failed to load user info:', error.message);
                    userInfo = { user: { username: 'User', id: 1 }, stats: { total_tasks: 0, completed_tasks: 0, pending_tasks: 0 } };
                }

                // Step 2: Load tasks (important)
                showLoadingOverlay('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô...');
                let tasks = [];
                try {
                    const tasksResponse = await apiCall('/tasks');
                    tasks = tasksResponse.tasks || tasksResponse || [];
                    // Render basic task view immediately
                    renderBasicDashboard(userInfo, tasks);
                } catch (error) {
                    console.warn('Failed to load tasks:', error.message);
                    tasks = createSampleTasks();
                    renderBasicDashboard(userInfo, tasks);
                }

                // Step 3: Load dashboard summary (optional)
                showLoadingOverlay('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
                let summary = null;
                try {
                    summary = await apiCall('/dashboard/summary');
                } catch (error) {
                    console.warn('Failed to load summary:', error.message);
                    summary = calculateSummaryFromTasks(tasks);
                }

                // Step 4: Render complete dashboard
                hideLoadingOverlay();
                renderCompleteDashboard(userInfo, tasks, summary);
                showToast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', 'success');

            } catch (error) {
                console.error('Critical error:', error);
                hideLoadingOverlay();
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                renderErrorState();
            }
        }

        function showLoadingOverlay(message) {
            const overlay = document.getElementById('api-loading');
            if (overlay) {
                overlay.style.display = 'flex';
                const messageEl = overlay.querySelector('.loading-text');
                if (messageEl) messageEl.textContent = message;
            }
        }

        function hideLoadingOverlay() {
            const overlay = document.getElementById('api-loading');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        function updateUserGreeting(username) {
            const greetingEl = document.getElementById('user-greeting');
            if (greetingEl) {
                greetingEl.textContent = `Welcome, ${username}`;
            }
        }

        // Render functions
        function renderBasicDashboard(userInfo, tasks) {
            const content = document.getElementById('content');
            if (!content) return;

            const stats = calculateBasicStats(userInfo, tasks);
            const todayTasks = getTodayTasks(tasks);
            const upcomingTasks = getUpcomingTasks(tasks);

            content.innerHTML = `
                <!-- Page Header -->
                <div class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">üìä Dashboard Overview</h1>
                    <p class="text-gray-600">${new Date().toLocaleDateString()}</p>
                </div>
                
                <!-- Quick Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="stats-widget p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                                <p class="text-2xl font-bold text-gray-900">${stats.totalTasks}</p>
                            </div>
                            <div class="p-3 bg-blue-100 rounded-lg">
                                <span class="text-2xl">üìã</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stats-widget p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</p>
                                <p class="text-2xl font-bold text-green-600">${stats.completedTasks}</p>
                            </div>
                            <div class="p-3 bg-green-100 rounded-lg">
                                <span class="text-2xl">‚úÖ</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stats-widget p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                                <p class="text-2xl font-bold text-orange-600">${todayTasks.length}</p>
                            </div>
                            <div class="p-3 bg-orange-100 rounded-lg">
                                <span class="text-2xl">üìÖ</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stats-widget p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>
                                <p class="text-2xl font-bold text-blue-600">${stats.completionRate}%</p>
                            </div>
                            <div class="p-3 bg-blue-100 rounded-lg">
                                <span class="text-2xl">üìä</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Task Lists -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Today's Tasks -->
                    <div class="excel-card p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">üìÖ ‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                        <div class="space-y-3">
                            ${generateTaskList(todayTasks.slice(0, 5))}
                        </div>
                    </div>
                    
                    <!-- Upcoming Tasks -->
                    <div class="excel-card p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">üîú ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á</h3>
                        <div class="space-y-3">
                            ${generateTaskList(upcomingTasks.slice(0, 5))}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCompleteDashboard(userInfo, tasks, summary) {
            const content = document.getElementById('content');
            if (!content) return;

            const stats = calculateBasicStats(userInfo, tasks);
            const todayTasks = getTodayTasks(tasks);
            const upcomingTasks = getUpcomingTasks(tasks);
            const overdueTasks = getOverdueTasks(tasks);
            const calendarHtml = generateCalendar(new Date(), tasks);

            content.innerHTML = `
                <!-- Page Header -->
                <div class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">üìä Dashboard Overview</h1>
                    <p class="text-gray-600">${new Date().toLocaleDateString()}</p>
                </div>
                
                <!-- Quick Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="stats-widget p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                                <p class="text-2xl font-bold text-gray-900">${stats.totalTasks}</p>
                            </div>
                            <div class="p-3 bg-blue-100 rounded-lg">
                                <span class="text-2xl">üìã</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stats-widget p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</p>
                                <p class="text-2xl font-bold text-green-600">${stats.completedTasks}</p>
                            </div>
                            <div class="p-3 bg-green-100 rounded-lg">
                                <span class="text-2xl">‚úÖ</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stats-widget p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà</p>
                                <p class="text-2xl font-bold text-orange-600">${stats.pendingTasks}</p>
                            </div>
                            <div class="p-3 bg-orange-100 rounded-lg">
                                <span class="text-2xl">‚è≥</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stats-widget p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>
                                <p class="text-2xl font-bold text-blue-600">${stats.completionRate}%</p>
                            </div>
                            <div class="p-3 bg-blue-100 rounded-lg">
                                <span class="text-2xl">üìä</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Dashboard Layout -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Today's Tasks -->
                    <div class="excel-card p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">üìÖ ‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                        <div class="space-y-3">
                            ${generateTaskList(todayTasks)}
                        </div>
                    </div>
                    
                    <!-- Calendar View -->
                    <div class="excel-card p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</h3>
                        ${calendarHtml}
                    </div>
                    
                    <!-- Upcoming & Overdue Tasks -->
                    <div class="space-y-6">
                        <div class="excel-card p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">üîú ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏°‡∏≤‡∏ñ‡∏∂‡∏á</h3>
                            <div class="space-y-3">
                                ${generateTaskList(upcomingTasks.slice(0, 5))}
                            </div>
                        </div>
                        
                        ${overdueTasks.length > 0 ? `
                        <div class="excel-card p-6 border-l-4 border-red-500">
                            <h3 class="text-lg font-medium text-red-600 mb-4">üö® ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î</h3>
                            <div class="space-y-3">
                                ${generateTaskList(overdueTasks.slice(0, 3))}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderErrorState() {
            const content = document.getElementById('content');
            if (!content) return;

            content.innerHTML = `
                <div class="text-center py-12">
                    <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h2>
                    <p class="text-gray-600 mb-6">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                    <button onclick="location.reload()" class="btn-professional">
                        üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
                    </button>
                </div>
            `;
        }

        // Helper functions
        function calculateBasicStats(userInfo, tasks) {
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(t => t.is_completed).length;
            const pendingTasks = totalTasks - completedTasks;
            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

            return {
                totalTasks,
                completedTasks,
                pendingTasks,
                completionRate
            };
        }

        function calculateSummaryFromTasks(tasks) {
            const completed = tasks.filter(t => t.is_completed).length;
            return {
                total_tasks: tasks.length,
                completed_tasks: completed,
                pending_tasks: tasks.length - completed,
                weekly_completed: getCompletedThisWeek(tasks)
            };
        }

        function createSampleTasks() {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            return [
                {
                    id: 1,
                    task_name: '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö Dashboard',
                    description: '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤ Dashboard',
                    due_date: today.toISOString(),
                    priority: 3,
                    is_completed: true,
                    created_at: today.toISOString(),
                    updated_at: today.toISOString()
                },
                {
                    id: 2,
                    task_name: '‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                    description: '‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô',
                    due_date: tomorrow.toISOString(),
                    priority: 2,
                    is_completed: false,
                    created_at: today.toISOString(),
                    updated_at: today.toISOString()
                },
                {
                    id: 3,
                    task_name: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà',
                    description: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£',
                    due_date: null,
                    priority: 1,
                    is_completed: false,
                    created_at: today.toISOString(),
                    updated_at: today.toISOString()
                }
            ];
        }

        // Task interaction functions
        async function toggleTask(taskId, isCompleted) {
            try {
                await apiCall(`/tasks/${taskId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ is_completed: isCompleted })
                });
                showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                // Reload dashboard data
                setTimeout(() => loadDashboardData(), 500);
            } catch (error) {
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ', 'error');
                console.error('Toggle task error:', error);
            }
        }

        async function editTask(taskId) {
            // Redirect to tasks page with edit mode
            window.location.href = `tasks.html?edit=${taskId}`;
        }

        async function deleteTask(taskId) {
            if (!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?')) return;
            
            try {
                await apiCall(`/tasks/${taskId}`, {
                    method: 'DELETE'
                });
                showToast('‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                // Reload dashboard data
                setTimeout(() => loadDashboardData(), 500);
            } catch (error) {
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ', 'error');
                console.error('Delete task error:', error);
            }
        }

        // Initialize dashboard on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            if (!token) {
                window.location.href = 'index.html';
                return;
            }

            // Load dashboard data sequentially
            loadDashboardData();
        });
    </script>
</body>
</html>
